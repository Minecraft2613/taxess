<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üí∏ Player Tax Portal</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom, #0e0e0e, #1a1a1a);
      color: white;
      padding: 20px;
      text-align: center;
    }
    .hidden { display: none; }
    .box {
      max-width: 600px;
      margin: auto;
      background: #1f1f1f;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px #444;
    }
    input, button {
      padding: 10px;
      width: 100%;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 5px;
      border: none;
    }
    input {
      background: #333;
      color: white;
    }
    button {
      background: #ffaa00;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }
    ul {
      list-style: none;
      padding: 0;
    }
  </style>
</head>
<body>
  <h1>üí∏ Player Tax Portal</h1>

  <div class="box" id="loginBox">
    <input id="mcid" placeholder="Enter your Minecraft Username" />
    <button onclick="nextStep()">Next</button>
  </div>

  <div class="box hidden" id="profileBox"></div>

  <script>
    const TAX_FILE = "https://raw.githubusercontent.com/Minecraft2613/tax/main/transaction-log.txt";

    let playerData = {}, currentPlayer = "";

    async function nextStep() {
      const mcid = document.getElementById("mcid").value.trim().toLowerCase();
      if (!mcid) return alert("Please enter your username");
      currentPlayer = mcid;
      document.getElementById("loginBox").classList.add("hidden");
      await loadTax();
    }

    async function loadTax() {
      try {
        const res = await fetch(TAX_FILE);
        const log = await res.text();
        parseLog(log);
      } catch (err) {
        alert("‚ùå Failed to load transaction log.");
        console.error(err);
      }
    }

    function parseLog(content) {
      const lines = content.split(/\r?\n/);
      const data = {};
      const buyRegex = /\[(.*?)\] - (\w+)\s+bought\s+.*?for\s+\$([\d,]+\.\d{2})\s+with/i;
      const sellRegex = /\[(.*?)\] - (\w+)\s+sold\s+.*?for\s+\$([\d,]+\.\d{2})\s+with/i;

      lines.forEach(line => {
        let match;
        if ((match = line.match(buyRegex))) {
          const [_, datetime, player, amountStr] = match;
          const amount = parseFloat(amountStr.replace(/,/g, ""));
          const tax = +(amount * 0.04).toFixed(2);
          const date = datetime.split(" ")[0];
          addTax(data, player.toLowerCase(), 0, tax, date);
        } else if ((match = line.match(sellRegex))) {
          const [_, datetime, player, amountStr] = match;
          const amount = parseFloat(amountStr.replace(/,/g, ""));
          const tax = +(amount * 0.10).toFixed(2);
          const date = datetime.split(" ")[0];
          addTax(data, player.toLowerCase(), tax, 0, date);
        }
      });

      playerData = data;
      renderProfile(currentPlayer);
    }

    function addTax(data, player, sellTax, buyTax, date) {
      if (!data[player]) data[player] = { sell: 0, buy: 0, days: {} };
      data[player].sell += sellTax;
      data[player].buy += buyTax;
      data[player].days[date] = (data[player].days[date] || 0) + sellTax + buyTax;
    }

    function renderProfile(player) {
      const record = playerData[player];

      if (!record) {
        document.getElementById("profileBox").innerHTML = `
          <h2>${player}</h2>
          <p>‚ùå Tax not found for this player.</p>
          <button onclick="logout()">Try Another</button>
        `;
        document.getElementById("profileBox").classList.remove("hidden");
        return;
      }

      const buyTax = record.buy.toFixed(2);
      const sellTax = record.sell.toFixed(2);
      const total = (record.buy + record.sell).toFixed(2);

      let daily = '';
      for (let d in record.days) {
        daily += `<li>${d}: $${record.days[d].toFixed(2)}</li>`;
      }

      document.getElementById("profileBox").innerHTML = `
        <h2>Welcome, ${player}</h2>
        <p><strong>üõí Buying Tax (4%):</strong> $${buyTax}</p>
        <p><strong>üì¶ Selling Tax (10%):</strong> $${sellTax}</p>
        <p><strong>üí∞ Total Tax:</strong> $${total}</p>
        ${daily ? `<h3>üìÖ Daily Breakdown</h3><ul>${daily}</ul>` : ""}
        <button onclick="logout()">Logout</button>
      `;
      document.getElementById("profileBox").classList.remove("hidden");
    }

    function logout() {
      document.getElementById("profileBox").classList.add("hidden");
      document.getElementById("loginBox").classList.remove("hidden");
      document.getElementById("mcid").value = "";
    }
  </script>
</body>
</html>
