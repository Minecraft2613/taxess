<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>💰 Player Tax Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #121212;
      color: white;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #ffcc00;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: none;
      border-radius: 6px;
      font-size: 16px;
    }
    input, select {
      background: #222;
      color: white;
    }
    button {
      background: #ffaa00;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }
    .profile-box, .history-box {
      background: #1b1b1b;
      padding: 15px;
      margin-top: 20px;
      border-radius: 10px;
    }
    canvas {
      max-width: 100%;
    }
    .btn-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📃 Player Tax Portal</h1>

    <div id="step1">
      <select id="job">
        <option>Farmer</option>
        <option>Miner</option>
        <option>Trader</option>
        <option>Builder</option>
      </select>
      <select id="method">
        <option value="Discord">Discord</option>
        <option value="Instagram">Instagram</option>
      </select>
      <input id="contact" placeholder="Your Discord/Instagram Username" />
      <input id="mcid" placeholder="Minecraft Username" />
      <button onclick="checkTax()">Check Tax</button>
    </div>

    <div id="profile" class="profile-box" style="display:none;"></div>
    <div id="historyBox" class="history-box" style="display:none;"></div>
    <canvas id="taxChart" style="display:none;"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const taxFile = "transaction-log.txt";
    const syncEndpoint = "https://sync.1987sakshamsingh.workers.dev/";
    const dataURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";

    let paidPlayers = {}, paymentHistory = {}, currentPlayer = "", dailyData = {}, chart;

    async function checkTax() {
      const contact = document.getElementById('contact').value.trim();
      const mcid = document.getElementById('mcid').value.trim();

      if (!contact || !mcid) return alert("Please fill all fields");

      currentPlayer = mcid;

      document.getElementById("step1").style.display = "none";
      await loadSavedData();
      await loadTaxLog();
    }

    async function loadSavedData() {
      try {
        const res = await fetch(dataURL);
        const json = await res.json();
        paidPlayers = json.paidPlayers || {};
        paymentHistory = json.paymentHistory || {};
      } catch (e) {
        alert("❌ Could not load tax data.");
      }
    }

    async function loadTaxLog() {
      try {
        const res = await fetch(taxFile);
        const text = await res.text();
        parseTransactions(text);
      } catch (e) {
        alert("❌ Failed to load transaction log.");
      }
    }

    function parseTransactions(text) {
      const lines = text.split(/\r?\n/);
      let buy = 0, sell = 0;
      dailyData = {};

      for (const line of lines) {
        if (!line.includes(currentPlayer)) continue;

        const dateMatch = line.match(/\[(\d{4}-\d{2}-\d{2})/);
        const day = dateMatch ? dateMatch[1].slice(5).replace('-', '/') : "";

        const buyMatch = line.match(/bought.*?\$([\d,]+\.\d{2})/);
        const sellMatch = line.match(/sold.*?\$([\d,]+\.\d{2})/);

        if (buyMatch) {
          const amt = parseFloat(buyMatch[1].replace(/,/g, ""));
          const tax = +(amt * 0.04).toFixed(2);
          buy += tax;
          dailyData[day] = (dailyData[day] || 0) + tax;
        }

        if (sellMatch) {
          const amt = parseFloat(sellMatch[1].replace(/,/g, ""));
          const tax = +(amt * 0.10).toFixed(2);
          sell += tax;
          dailyData[day] = (dailyData[day] || 0) + tax;
        }
      }

      const total = buy + sell;
      const paid = paidPlayers[currentPlayer] || 0;
      const due = Math.max(0, total - paid);
      const advanced = paid > total;

      showProfile(buy, sell, total, paid, due, advanced);
      renderChart();
    }

    function showProfile(buy, sell, total, paid, due, advanced) {
      const box = document.getElementById("profile");
      box.innerHTML = `
        <h3>Welcome, ${currentPlayer}</h3>
        <p>Total Tax: $${total.toFixed(2)}</p>
        <p>Buying Tax: $${buy.toFixed(2)} | Selling Tax: $${sell.toFixed(2)}</p>
        <p>Status: <strong>${due === 0 ? (advanced ? "Advance Paid" : "No Tax Due") : "$" + due.toFixed(2) + " Due"}</strong></p>
        <input type="number" id="payAmt" placeholder="Enter amount to pay">
        <div class="btn-row">
          ${due > 0 ? `<button onclick="submitTax()">Pay Tax</button>` : ""}
          ${due === 0 ? `<button onclick="submitTax()">Advance Pay</button>` : ""}
          <button onclick="reset()">Exit</button>
        </div>`;

      box.style.display = "block";

      const hist = paymentHistory[currentPlayer] || [];
      const historyBox = document.getElementById("historyBox");
      historyBox.innerHTML = `<h3>Payment History</h3><ul>${hist.map(p => `<li>$${p.amount} on ${p.date}</li>`).join('')}</ul>`;
      historyBox.style.display = "block";
    }

    async function submitTax() {
      const amt = parseFloat(document.getElementById("payAmt").value);
      if (!amt || amt <= 0) return alert("Enter a valid amount");

      paidPlayers[currentPlayer] = (paidPlayers[currentPlayer] || 0) + amt;

      const entry = {
        amount: amt,
        date: new Date().toLocaleString()
      };

      if (!paymentHistory[currentPlayer]) paymentHistory[currentPlayer] = [];
      paymentHistory[currentPlayer].push(entry);

      try {
        await syncToCloudflare();
        alert("✅ Payment recorded!");
        loadTaxLog();
      } catch (err) {
        console.error("❌ Failed to sync:", err);
        alert("❌ Failed to sync data.");
      }
    }

    async function syncToCloudflare() {
      const res = await fetch(syncEndpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          paidPlayers,
          paymentHistory
        })
      });

      if (!res.ok) {
        const err = await res.text();
        throw new Error("❌ Sync failed: " + err);
      }

      console.log("✅ Synced to Cloudflare");
    }

    function renderChart() {
      const ctx = document.getElementById("taxChart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Object.keys(dailyData),
          datasets: [{
            label: "Daily Tax",
            data: Object.values(dailyData),
            borderColor: "#ffcc00",
            fill: false,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { title: { display: true, text: "Date" } },
            y: { title: { display: true, text: "Tax ($)" } }
          }
        }
      });
      document.getElementById("taxChart").style.display = "block";
    }

    function reset() {
      document.getElementById("step1").style.display = "block";
      document.getElementById("profile").style.display = "none";
      document.getElementById("historyBox").style.display = "none";
      document.getElementById("taxChart").style.display = "none";
      document.getElementById("contact").value = "";
      document.getElementById("mcid").value = "";
    }
  </script>
</body>
</html>
