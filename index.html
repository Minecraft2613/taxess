<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“Ÿ Player Tax Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f0f0f, #1e1e1e);
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    h1, h2 { text-align: center; color: #ffcc00; }
    .container {
      max-width: 800px;
      margin: auto;
    }
    select, input, button {
      width: 100%; margin: 10px 0; padding: 10px;
      font-size: 16px; border-radius: 5px;
    }
    input, select {
      background: #222; color: #fff; border: 1px solid #555;
    }
    button {
      background: #ffaa00; color: #000; border: none;
      cursor: pointer;
    }
    .hidden { display: none; }
    .box {
      background: #111; padding: 20px; border-radius: 10px;
      box-shadow: 0 0 10px #ffaa00aa;
    }
    .history-box {
      margin-top: 20px;
      background: #222;
      padding: 10px;
      border-radius: 8px;
    }
    canvas {
      background: #fff;
      margin-top: 15px;
      border-radius: 10px;
      max-width: 100%;
    }
    @media (max-width: 600px) {
      select, input, button { font-size: 14px; padding: 8px; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ðŸ“Ÿ Player Tax Portal</h1>

  <div id="loginBox" class="box">
    <label>Select Job:</label>
    <select id="job">
      <option value="Farmer">Farmer</option>
      <option value="Miner">Miner</option>
      <option value="Builder">Builder</option>
      <option value="Trader">Trader</option>
    </select>

    <label>Contact Method:</label>
    <select id="contact">
      <option value="Discord">Discord</option>
      <option value="Instagram">Instagram</option>
    </select>

    <input id="contactUsername" placeholder="Enter your Discord or Instagram username">
    <input id="mcid" placeholder="Enter your Minecraft Username">
    <button onclick="submitLogin()">Check Tax</button>
  </div>

  <div id="profileBox" class="box hidden"></div>
  <canvas id="taxChart" width="600" height="300" class="hidden"></canvas>

  <script>
    const webhook = "https://discordapp.com/api/webhooks/1385267628842684526/7aw6Ms9TLRUHfEvQK0Y6aQvj8zwy4TS0WIgdRQe0iGcOZeZg3r95gT3UTep4jhK3NhWZ";
    const paidPlayers = JSON.parse(localStorage.getItem('paidPlayers') || '{}');
    const paymentHistory = JSON.parse(localStorage.getItem('paymentHistory') || '{}');
    let currentPlayer = '', playerCaseName = '', taxData = {};

    async function submitLogin() {
      const job = document.getElementById("job").value;
      const contactType = document.getElementById("contact").value;
      const contactUser = document.getElementById("contactUsername").value.trim();
      const mcid = document.getElementById("mcid").value.trim();

      if (!mcid || !contactUser) return alert("Fill all fields!");
      currentPlayer = mcid;
      playerCaseName = mcid;

      fetch(webhook, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: `ðŸ“… Login Info:\nðŸ‘¤ Minecraft ID: ${mcid}\nðŸ’¼ Job: ${job}\nðŸ“¬ ${contactType}: ${contactUser}` })
      });

      loadTransactionLog();
    }

    async function loadTransactionLog() {
      try {
        const res = await fetch("transaction-log.txt");
        const text = await res.text();
        parseTransactions(text);
      } catch (e) {
        alert("Failed to load transaction-log.txt!");
      }
    }

    function parseTransactions(data) {
      const lines = data.split(/\r?\n/);
      const player = currentPlayer;
      let totalBuy = 0, totalSell = 0;
      const perDay = {};

      lines.forEach(line => {
        if (!line.includes(player)) return;
        const buyMatch = line.match(/\[(.*?)\] - (\w+) bought .*? for \$([\d,]+\.\d+)/);
        const sellMatch = line.match(/\[(.*?)\] - (\w+) sold .*? for \$([\d,]+\.\d+)/);

        if (buyMatch && buyMatch[2] === player) {
          const date = buyMatch[1].split(" ")[0];
          const amt = parseFloat(buyMatch[3].replace(/,/g, ""));
          const tax = +(amt * 0.04).toFixed(2);
          totalBuy += tax;
          perDay[date] = (perDay[date] || 0) + tax;
        }

        if (sellMatch && sellMatch[2] === player) {
          const date = sellMatch[1].split(" ")[0];
          const amt = parseFloat(sellMatch[3].replace(/,/g, ""));
          const tax = +(amt * 0.10).toFixed(2);
          totalSell += tax;
          perDay[date] = (perDay[date] || 0) + tax;
        }
      });

      taxData = { totalBuy, totalSell, total: +(totalBuy + totalSell).toFixed(2), perDay };
      renderProfile();
    }

    function renderProfile() {
      const { total, totalBuy, totalSell, perDay } = taxData;
      const paid = paidPlayers[currentPlayer] || 0;
      const due = Math.max(0, total - paid);
      const advance = paid > total;

      const history = (paymentHistory[currentPlayer] || []).map(e => `<li>$${e.amount} on ${e.date}</li>`).join('');

      document.getElementById("profileBox").innerHTML = `
        <h2>Welcome, ${playerCaseName}</h2>
        <p><strong>Total Tax:</strong> $${total.toFixed(2)}</p>
        <p><strong>Buying Tax:</strong> $${totalBuy.toFixed(2)}</p>
        <p><strong>Selling Tax:</strong> $${totalSell.toFixed(2)}</p>
        <p><strong>Status:</strong> ${due === 0 ? (advance ? 'Advance Paid' : 'No Tax Due') : '$' + due.toFixed(2) + ' Due'}</p>
        ${due > 0 ? `<input type="number" id="payAmt" placeholder="Enter amount to pay"><button onclick="payTax()">Pay Tax</button>` : `<input type="number" id="payAmt" placeholder="Enter advance payment"><button onclick="advancePay()">Advance Pay</button>`}
        <button onclick="drawChart()">ðŸ“Š Show Tax Chart</button>
        <button onclick="reset()">Exit</button>
        ${history ? `<div class="history-box"><h3>Payment History</h3><ul>${history}</ul></div>` : ""}`;

      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("profileBox").classList.remove("hidden");
    }

    function drawChart() {
      const canvas = document.getElementById("taxChart");
      const ctx = canvas.getContext("2d");
      canvas.classList.remove("hidden");

      const labels = Object.keys(taxData.perDay);
      const values = Object.values(taxData.perDay);
      const maxVal = Math.max(...values) * 1.2;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      values.forEach((v, i) => {
        const x = 60 + i * 50;
        const h = (v / maxVal) * 200;
        ctx.fillStyle = '#ffaa00';
        ctx.fillRect(x, 280 - h, 40, h);
        ctx.fillStyle = '#fff';
        ctx.fillText(labels[i], x, 295);
      });
    }

    function payTax() {
      const amt = parseFloat(document.getElementById("payAmt").value);
      if (!amt || amt <= 0) return alert("Enter valid amount!");
      paidPlayers[currentPlayer] = (paidPlayers[currentPlayer] || 0) + amt;
      recordHistory(amt, "Tax Paid");
      renderProfile();
    }

    function advancePay() {
      const amt = parseFloat(document.getElementById("payAmt").value);
      if (!amt || amt <= 0) return alert("Enter valid amount!");
      paidPlayers[currentPlayer] = (paidPlayers[currentPlayer] || 0) + amt;
      recordHistory(amt, "Advance Payment");
      renderProfile();
    }

    function recordHistory(amt, type) {
      const entry = { amount: amt, date: new Date().toLocaleString() };
      if (!paymentHistory[currentPlayer]) paymentHistory[currentPlayer] = [];
      paymentHistory[currentPlayer].push(entry);
      localStorage.setItem('paidPlayers', JSON.stringify(paidPlayers));
      localStorage.setItem('paymentHistory', JSON.stringify(paymentHistory));

      fetch(webhook, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: `ðŸ’¸ ${type} by ${currentPlayer} - $${amt}` })
      });

      // Backup JSON to Discord
      fetch(webhook, {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: 'Backup: ```json\n' + JSON.stringify(paymentHistory[currentPlayer], null, 2) + '\n```' })
      });
    }

    function reset() {
      document.getElementById("profileBox").classList.add("hidden");
      document.getElementById("loginBox").classList.remove("hidden");
      document.getElementById("taxChart").classList.add("hidden");
    }
  </script>
</div>
</body>
</html>
