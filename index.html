<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üí∏ Player Tax Portal</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom, #0e0e0e, #1a1a1a);
      color: white;
      padding: 20px;
      text-align: center;
    }
    .hidden { display: none; }
    .box {
      max-width: 600px;
      margin: auto;
      background: #1f1f1f;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px #444;
    }
    input, button {
      padding: 10px;
      width: 100%;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 5px;
      border: none;
    }
    input {
      background: #333;
      color: white;
    }
    button {
      background: #ffaa00;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }
    ul {
      list-style: none;
      padding: 0;
    }
  </style>
</head>
<body>
  <h1>üí∏ Player Tax Portal</h1>

  <div class="box" id="loginBox">
    <input id="mcid" placeholder="Enter your Minecraft Username" />
    <button onclick="nextStep()">Next</button>
  </div>

  <div class="box hidden" id="profileBox"></div>

  <script>
    const TAX_FILE = "https://raw.githubusercontent.com/Minecraft2613/tax/main/transaction-log.txt";

    const paidPlayers = JSON.parse(localStorage.getItem('paidCombined') || '{}');
    const paymentHistory = JSON.parse(localStorage.getItem('combinedHistory') || '{}');
    let playerData = {}, currentPlayer = "";

    async function nextStep() {
      const mcid = document.getElementById("mcid").value.trim().toLowerCase();
      if (!mcid) return alert("Please enter your username");
      currentPlayer = mcid;
      document.getElementById("loginBox").classList.add("hidden");
      await loadTax();
    }

    async function loadTax() {
      try {
        const res = await fetch(TAX_FILE);
        const log = await res.text();
        parseLog(log);
      } catch (err) {
        alert("‚ùå Failed to load transaction log.");
        console.error(err);
      }
    }

    function parseLog(content) {
      const lines = content.split(/\r?\n/);
      const data = {};
      const sellRegex = /\[(.*?)\]\s*-\s*(\w+)\s+sold\s+.*?\s+for\s+\$([\d,]+\.\d{2})\s+with/;
      const buyRegex = /\[(.*?)\]\s*-\s*(\w+)\s+bought\s+.*?\s+for\s+\$([\d,]+\.\d{2})\s+with/;

      lines.forEach(line => {
        let match;
        if ((match = line.match(sellRegex))) {
          const [_, datetime, name, amount] = match;
          const tax = +(parseFloat(amount.replace(/,/g, "")) * 0.10).toFixed(2);
          const date = datetime.split(" ")[0];
          addTax(data, name.toLowerCase(), tax, 0, date);
        } else if ((match = line.match(buyRegex))) {
          const [_, datetime, name, amount] = match;
          const tax = +(parseFloat(amount.replace(/,/g, "")) * 0.04).toFixed(2);
          const date = datetime.split(" ")[0];
          addTax(data, name.toLowerCase(), 0, tax, date);
        }
      });

      playerData = data;
      renderProfile(currentPlayer);
    }

    function addTax(obj, name, sellTax, buyTax, date) {
      if (!obj[name]) obj[name] = { sell: 0, buy: 0, days: {} };
      obj[name].sell += sellTax;
      obj[name].buy += buyTax;
      obj[name].days[date] = (obj[name].days[date] || 0) + sellTax + buyTax;
    }

    function renderProfile(name) {
      const record = playerData[name];

      if (!record) {
        document.getElementById("profileBox").innerHTML = `
          <h2>${name}</h2>
          <p>‚ùå Tax not found for this player.</p>
          <button onclick="logout()">Try Another</button>
        `;
        document.getElementById("profileBox").classList.remove("hidden");
        return;
      }

      const paid = paidPlayers[name] || 0;
      const totalTax = +(record.sell + record.buy).toFixed(2);
      const due = Math.max(0, totalTax - paid);
      const advance = paid > totalTax;

      let dailyBreakdown = "";
      for (const date in record.days) {
        dailyBreakdown += `<li>${date}: $${record.days[date].toFixed(2)}</li>`;
      }

      const history = (paymentHistory[name] || [])
        .map(e => `<li>$${e.amount} on ${e.date}</li>`).join('');

      document.getElementById("profileBox").innerHTML = `
        <h2>Welcome, ${name}</h2>
        <p><strong>Buying Tax:</strong> $${record.buy.toFixed(2)}</p>
        <p><strong>Selling Tax:</strong> $${record.sell.toFixed(2)}</p>
        <p><strong>Total Tax:</strong> $${totalTax.toFixed(2)}</p>
        <p><strong>Status:</strong> ${due === 0 ? (advance ? "Advance Paid" : "No Tax Due") : "$" + due.toFixed(2) + " Due"}</p>

        <input type="number" id="payAmt" placeholder="Enter amount to pay" />
        <button onclick="submitTax('${name}')">Pay Tax</button>
        <button onclick="advancePay('${name}')">Advance Pay</button>
        <button onclick="logout()">Logout</button>

        ${dailyBreakdown ? `<h3>üìÖ Daily Tax</h3><ul>${dailyBreakdown}</ul>` : ""}
        ${history ? `<h3>üìú Payment History</h3><ul>${history}</ul>` : ""}
      `;
      document.getElementById("profileBox").classList.remove("hidden");
    }

    function recordHistory(name, amt) {
      const entry = { amount: amt, date: new Date().toLocaleString() };
      if (!paymentHistory[name]) paymentHistory[name] = [];
      paymentHistory[name].push(entry);
      localStorage.setItem("combinedHistory", JSON.stringify(paymentHistory));
    }

    function submitTax(name) {
      const amt = parseFloat(document.getElementById("payAmt").value);
      if (!amt || amt <= 0) return alert("Enter a valid amount");
      paidPlayers[name] = (paidPlayers[name] || 0) + amt;
      recordHistory(name, amt);
      localStorage.setItem("paidCombined", JSON.stringify(paidPlayers));
      webhookNotify(`${name} paid $${amt} in tax`);
      renderProfile(name);
    }

    function advancePay(name) {
      const amt = parseFloat(document.getElementById("payAmt").value);
      if (!amt || amt <= 0) return alert("Enter a valid amount");
      paidPlayers[name] = (paidPlayers[name] || 0) + amt;
      recordHistory(name, amt);
      localStorage.setItem("paidCombined", JSON.stringify(paidPlayers));
      webhookNotify(`${name} made advance payment of $${amt}`);
      renderProfile(name);
    }

    function logout() {
      document.getElementById("profileBox").classList.add("hidden");
      document.getElementById("loginBox").classList.remove("hidden");
      document.getElementById("mcid").value = "";
    }

    function webhookNotify(message) {
      fetch("https://discord.com/api/webhooks/YOUR_WEBHOOK_URL", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: `üì• ${message}` })
      }).catch(() => {});
    }
  </script>
</body>
</html>
