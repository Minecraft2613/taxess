<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player Tax Portal</title>
  <style>
    body {
      background: #121212;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    h1, h2 {
      color: gold;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #1e1e1e;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
    }
    button {
      background: orange;
      color: black;
      font-weight: bold;
    }
    .chart-container {
      background: #202020;
      border-radius: 8px;
      padding: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Welcome, <span id="playerName"></span></h1>
    <h2>Total Tax: <span id="totalTax">Loading...</span></h2>
    <h2>Buying Tax: <span id="buyTax">Loading...</span></h2>
    <h2>Status: <span id="dueTax">Loading...</span></h2>

    <input type="number" id="taxAmount" placeholder="Enter amount to pay">
    <button onclick="payTax()">Pay Tax</button>
    <button onclick="exitPortal()">Exit</button>

    <div>
      <h2>Advanced Pay</h2>
      <input type="number" id="advanceAmount" placeholder="Advance pay">
      <button onclick="advancePay()">Submit Advance</button>
    </div>

    <div class="chart-container">
      <canvas id="taxChart" height="150"></canvas>
    </div>

    <h2>Payment History</h2>
    <ul id="paymentHistory"></ul>

    <h2>Contact</h2>
    <select id="contactMethod">
      <option value="Discord">Discord</option>
      <option value="Instagram">Instagram</option>
    </select>
    <input type="text" id="contactName" placeholder="Enter contact username">

    <h2>Job</h2>
    <select id="jobSelect">
      <option value="Farmer">Farmer</option>
      <option value="Miner">Miner</option>
      <option value="Builder">Builder</option>
      <option value="Hunter">Hunter</option>
    </select>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const player = localStorage.getItem("mc_username") || prompt("Enter your Minecraft username:");
    localStorage.setItem("mc_username", player);
    document.getElementById("playerName").innerText = player;

    const taxUrl = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
    const githubToken = "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"; // Put your real token here (not recommended!)

    async function fetchTax() {
      const res = await fetch(taxUrl);
      const data = await res.json();
      const playerData = data[player] || { totalTax: 0, buyTax: 0, history: [] };

      document.getElementById("totalTax").innerText = `$${playerData.totalTax.toFixed(2)}`;
      document.getElementById("buyTax").innerText = `$${playerData.buyTax.toFixed(2)}`;
      document.getElementById("dueTax").innerText = `$${(playerData.totalTax - (playerData.paid || 0)).toFixed(2)} Due`;

      updateHistory(playerData.history);
      drawChart(playerData.history);
    }

    function updateHistory(history) {
      const list = document.getElementById("paymentHistory");
      list.innerHTML = "";
      history.forEach(entry => {
        const li = document.createElement("li");
        li.textContent = `$${entry.amount} on ${entry.date}`;
        list.appendChild(li);
      });
    }

    function drawChart(history) {
      const ctx = document.getElementById("taxChart").getContext("2d");
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: history.map(e => e.date),
          datasets: [{
            label: 'Tax Paid',
            data: history.map(e => e.amount),
            borderColor: 'orange',
            fill: false
          }]
        }
      });
    }

    async function payTax() {
      const amount = parseFloat(document.getElementById("taxAmount").value);
      if (!amount || amount <= 0) return alert("Enter valid amount");
      await saveTax(amount);
    }

    async function advancePay() {
      const amount = parseFloat(document.getElementById("advanceAmount").value);
      if (!amount || amount <= 0) return alert("Enter valid amount");
      await saveTax(amount, true);
    }

    async function saveTax(amount, isAdvance = false) {
      const res = await fetch(taxUrl);
      const json = await res.json();
      const playerData = json[player] || { totalTax: 0, buyTax: 0, paid: 0, history: [] };

      playerData.paid = (playerData.paid || 0) + amount;
      playerData.history.push({ amount, date: new Date().toLocaleString(), advance: isAdvance });
      json[player] = playerData;

      const content = JSON.stringify(json, null, 2);

      const result = await fetch("https://api.github.com/repos/Minecraft2613/taxess/contents/tax-data.json", {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${githubToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Update tax-data.json for ${player}`,
          content: btoa(unescape(encodeURIComponent(content))),
          sha: await getCurrentSha(),
        })
      });

      if (!result.ok) {
        alert("Save failed: " + (await result.text()));
      } else {
        alert("Tax Paid and Saved!");
        fetchTax();
      }
    }

    async function getCurrentSha() {
      const res = await fetch("https://api.github.com/repos/Minecraft2613/taxess/contents/tax-data.json");
      const json = await res.json();
      return json.sha;
    }

    function exitPortal() {
      localStorage.removeItem("mc_username");
      location.reload();
    }

    fetchTax();
  </script>
</body>
</html>
