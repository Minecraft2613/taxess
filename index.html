<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸ’¼ Player Tax Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f0f0f, #1e1e1e);
      color: #fff;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    h1 { text-align: center; color: #ffcc00; }
    input, button {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 6px;
      border: none;
    }
    input {
      background: #222;
      color: #fff;
      border: 1px solid #444;
    }
    button {
      background: #ff8800;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }
    .profile-box, .history-box {
      background: #111;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
    }
    canvas { width: 100% !important; height: auto !important; }
  </style>
</head>
<body>
<div class="container">
  <h1>ðŸ“ƒ Player Tax Portal</h1>
  <input id="mcid" placeholder="Enter your Minecraft Username" />
  <button onclick="checkTax()">Check Tax</button>
  <div id="profile" class="profile-box" style="display:none;"></div>
  <div id="historyBox" class="history-box" style="display:none;"></div>
  <canvas id="taxChart" style="display:none;"></canvas>
</div>

<script>
let paidPlayers = {}, paymentHistory = {}, currentPlayer = '', dailyData = {};

function checkTax() {
  currentPlayer = document.getElementById('mcid').value.trim();
  if (!currentPlayer) return alert("Please enter your Minecraft username");
  loadTax();
}

async function loadTax() {
  try {
    const res = await fetch("transaction-log.txt");
    const text = await res.text();
    parseTransactions(text);
  } catch {
    alert("Failed to load transaction log.");
  }
}

function parseTransactions(log) {
  const lines = log.split(/\r?\n/);
  let buy = 0, sell = 0;
  dailyData = {};

  lines.forEach(line => {
    if (!line.toLowerCase().includes(currentPlayer.toLowerCase())) return;
    const date = line.match(/\[(\d{4}-\d{2}-\d{2})/);
    const day = date ? date[1].slice(5).replace('-', '/') : "";
    const buyMatch = line.match(/bought.*?\$(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/);
    const sellMatch = line.match(/sold.*?\$(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/);
    if (buyMatch) {
      const amt = parseFloat(buyMatch[1].replace(/,/g, ""));
      const tax = +(amt * 0.04).toFixed(2);
      buy += tax;
      dailyData[day] = (dailyData[day] || 0) + tax;
    }
    if (sellMatch) {
      const amt = parseFloat(sellMatch[1].replace(/,/g, ""));
      const tax = +(amt * 0.10).toFixed(2);
      sell += tax;
      dailyData[day] = (dailyData[day] || 0) + tax;
    }
  });

  const total = buy + sell;
  showProfile(buy, sell, total);
  renderChart();
}

function showProfile(buy, sell, total) {
  const box = document.getElementById("profile");
  box.innerHTML = `<h3>Welcome, ${currentPlayer}</h3>
    <p>Buying Tax: $${buy.toFixed(2)}</p>
    <p>Selling Tax: $${sell.toFixed(2)}</p>
    <p>Total Tax Due: $${total.toFixed(2)}</p>`;
  box.style.display = "block";

  const histBox = document.getElementById("historyBox");
  histBox.innerHTML = `<h3>Payment History</h3><p>No payment data loaded.</p>`;
  histBox.style.display = "block";
}

function renderChart() {
  const ctx = document.getElementById("taxChart").getContext("2d");
  const labels = Object.keys(dailyData);
  const values = Object.values(dailyData);
  document.getElementById("taxChart").style.display = "block";
  if (window.chart) window.chart.destroy();
  window.chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{ label: "Daily Tax ($)", data: values, backgroundColor: '#ffaa00' }]
    },
    options: { scales: { y: { beginAtZero: true } } }
  });
}
</script>
</body>
</html>
