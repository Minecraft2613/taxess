<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>📊 Player Tax Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      background: #121212;
      color: #fff;
      padding: 20px;
      margin: 0;
    }
    h1 { text-align: center; color: gold; }
    .container {
      max-width: 700px;
      margin: auto;
      background: #1e1e1e;
      border-radius: 10px;
      padding: 20px;
    }
    input, select, button {
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background: #2a2a2a;
      color: white;
    }
    button {
      background: orange;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }
    .row { margin: 20px 0; }
    .graph { margin-top: 30px; }
    canvas { width: 100% !important; }
  </style>
</head>
<body>
  <div class="container">
    <h1>📋 Player Tax Portal</h1>

    <div id="form">
      <select id="job">
        <option>Miner</option><option>Farmer</option><option>Trader</option><option>Builder</option>
      </select>
      <select id="method">
        <option value="Discord">Discord</option>
        <option value="Instagram">Instagram</option>
      </select>
      <input id="contact" placeholder="Your Discord/Instagram username">
      <input id="mcid" placeholder="Your Minecraft Username (case-sensitive)">
      <button onclick="checkTax()">Check Tax</button>
    </div>

    <div id="result" style="display:none;">
      <h2 id="welcome"></h2>
      <p id="taxInfo"></p>
      <input id="payAmt" type="number" placeholder="Enter amount to pay">
      <div class="row">
        <button onclick="submitTax()">💰 Pay Tax</button>
        <button onclick="advancePay()">↗️ Advance Pay</button>
        <button onclick="reset()">🔄 Reset</button>
      </div>
      <div class="graph">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const syncURL = "https://sync.1987sakshamsingh.workers.dev/";
    const dataURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
    let paidPlayers = {}, paymentHistory = {}, currentPlayer = "", chart, dailyData = {}, totalTax = 0;

    async function checkTax() {
      const mcid = document.getElementById("mcid").value.trim();
      const contact = document.getElementById("contact").value.trim();
      const method = document.getElementById("method").value;
      const job = document.getElementById("job").value;

      if (!mcid || !contact) return alert("Please fill all fields");
      currentPlayer = mcid;

      try {
        const res = await fetch(dataURL);
        const json = await res.json();
        paidPlayers = json.paidPlayers || {};
        paymentHistory = json.paymentHistory || {};
      } catch {
        alert("❌ Failed to load tax database");
        return;
      }

      try {
        const logRes = await fetch("transaction-log.txt");
        const log = await logRes.text();
        parseTransactions(log);
      } catch {
        alert("❌ Failed to load transaction log");
      }
    }

    function parseTransactions(log) {
      const lines = log.split("\n");
      let buy = 0, sell = 0;
      dailyData = {};

      for (let line of lines) {
        if (!line.includes(currentPlayer)) continue;
        const dateMatch = line.match(/\[(\d{4}-\d{2}-\d{2})/);
        const date = dateMatch ? dateMatch[1].slice(5) : "Unknown";
        const buyMatch = line.match(/bought.*?\$([\d,]+\.\d{2})/);
        const sellMatch = line.match(/sold.*?\$([\d,]+\.\d{2})/);

        if (buyMatch) {
          const amt = parseFloat(buyMatch[1].replace(/,/g, ""));
          const tax = +(amt * 0.04).toFixed(2);
          buy += tax;
          dailyData[date] = (dailyData[date] || 0) + tax;
        }
        if (sellMatch) {
          const amt = parseFloat(sellMatch[1].replace(/,/g, ""));
          const tax = +(amt * 0.10).toFixed(2);
          sell += tax;
          dailyData[date] = (dailyData[date] || 0) + tax;
        }
      }

      totalTax = +(buy + sell).toFixed(2);
      const paid = paidPlayers[currentPlayer] || 0;
      const due = Math.max(0, totalTax - paid);
      const advanced = paid > totalTax;

      document.getElementById("form").style.display = "none";
      document.getElementById("result").style.display = "block";
      document.getElementById("welcome").innerText = `Welcome, ${currentPlayer}`;
      document.getElementById("taxInfo").innerHTML =
        `🧾 Total Tax: $${totalTax}<br>
         💵 Paid: $${paid.toFixed(2)}<br>
         💸 Due: $${due.toFixed(2)}<br>
         ${advanced ? "✅ Advance paid" : due === 0 ? "✅ No tax due" : "❗ Pending payment"}`;

      renderChart();
    }

    function renderChart() {
      const ctx = document.getElementById("chart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Object.keys(dailyData),
          datasets: [{
            label: "Daily Tax",
            data: Object.values(dailyData),
            borderColor: "gold",
            borderWidth: 2,
            fill: false,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true },
            x: { title: { display: true, text: "Date" } }
          }
        }
      });
    }

    async function submitTax() {
      const amt = parseFloat(document.getElementById("payAmt").value);
      if (!amt || amt <= 0) return alert("Invalid amount");

      paidPlayers[currentPlayer] = (paidPlayers[currentPlayer] || 0) + amt;
      paymentHistory[currentPlayer] = paymentHistory[currentPlayer] || [];
      paymentHistory[currentPlayer].push({ amount: amt, date: new Date().toLocaleString() });

      const payload = [{
        player: currentPlayer,
        amount: amt,
        contact: document.getElementById("contact").value,
        method: document.getElementById("method").value,
        job: document.getElementById("job").value,
        timestamp: new Date().toISOString()
      }];

      try {
        const res = await fetch(syncURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`❌ Sync failed: ${text}`);
        }
        console.log("☁️ Sync: ✅ Synced successfully");
      } catch (err) {
        console.warn("☁️ Sync: ❌ Failed to sync:", err.message);
      }

      checkTax();
    }

    function advancePay() {
      submitTax();
    }

    function reset() {
      document.getElementById("form").style.display = "block";
      document.getElementById("result").style.display = "none";
      document.getElementById("payAmt").value = "";
    }
  </script>
</body>
</html>
