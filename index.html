<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>💼 Player Tax Portal</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #111;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
    }
    h1 {
      text-align: center;
      color: #ffcc00;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 6px;
      border: none;
    }
    input {
      background: #222;
      color: white;
      border: 1px solid #444;
    }
    button {
      background: #ff8800;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }
    .profile-box {
      background: #1b1b1b;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📃 Player Tax Portal</h1>
    <input id="mcid" placeholder="Enter your Minecraft Username" />
    <button onclick="checkTax()">Check Tax</button>
    
    <div id="profile" class="profile-box" style="display:none;"></div>
  </div>

  <script>
    const jsonDataURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
    const cloudflareURL = "https://sync.1987sakshamsingh.workers.dev/";

    let paidPlayers = {}, paymentHistory = {}, currentPlayer = "";

    async function checkTax() {
      const mcid = document.getElementById("mcid").value.trim();
      if (!mcid) return alert("Please enter your Minecraft username");
      currentPlayer = mcid;

      document.getElementById("profile").style.display = "none";

      try {
        const res = await fetch(jsonDataURL);
        const data = await res.json();
        paidPlayers = data.paidPlayers || {};
        paymentHistory = data.paymentHistory || {};
      } catch {
        alert("⚠️ Could not load tax data.");
        return;
      }

      try {
        const res = await fetch("transaction-log.txt");
        const text = await res.text();
        parseTransactions(text);
      } catch {
        alert("⚠️ Could not load transaction log.");
      }
    }

    function parseTransactions(log) {
      const lines = log.split(/\r?\n/);
      let buy = 0, sell = 0;

      lines.forEach(line => {
        if (!line.toLowerCase().includes(currentPlayer.toLowerCase())) return;

        const buyMatch = line.match(/bought.*?\$([\d,]+\.\d{2})/);
        const sellMatch = line.match(/sold.*?\$([\d,]+\.\d{2})/);

        if (buyMatch) {
          const amt = parseFloat(buyMatch[1].replace(/,/g, ""));
          buy += +(amt * 0.04).toFixed(2);
        }

        if (sellMatch) {
          const amt = parseFloat(sellMatch[1].replace(/,/g, ""));
          sell += +(amt * 0.10).toFixed(2);
        }
      });

      const total = +(buy + sell).toFixed(2);
      const paid = +(paidPlayers[currentPlayer] || 0);
      const due = Math.max(0, total - paid);

      showProfile(buy, sell, total, paid, due);
      if (due > 0) syncToCloudflare(currentPlayer, due);
    }

    function showProfile(buy, sell, total, paid, due) {
      const box = document.getElementById("profile");
      box.innerHTML = `
        <h3>👤 ${currentPlayer}</h3>
        <p>🧾 Buying Tax: $${buy.toFixed(2)}<br>
        💰 Selling Tax: $${sell.toFixed(2)}<br>
        🧮 Total Tax: $${total.toFixed(2)}<br>
        ✅ Paid: $${paid.toFixed(2)}<br>
        🔴 Due: <strong>$${due.toFixed(2)}</strong></p>
        ${paymentHistory[currentPlayer] ? `<p>📜 Payment History:<br><ul>${
          paymentHistory[currentPlayer].map(e => `<li>${e.amount ? `$${e.amount}` : `Due $${e.due}`} - ${e.syncedAt || e.date}</li>`).join('')
        }</ul></p>` : ''}
      `;
      box.style.display = "block";
    }

    function syncToCloudflare(player, due) {
      fetch(cloudflareURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ player: player, due: due })
      })
      .then(res => res.text())
      .then(msg => console.log("☁️ Sync Result:", msg))
      .catch(err => console.warn("Cloudflare Error:", err));
    }
  </script>
</body>
</html>
