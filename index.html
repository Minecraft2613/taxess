<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Player Tax Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f0f0f, #1e1e1e);
      color: #fff;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    input, select, button {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 6px;
      border: none;
    }
    input, select {
      background: #222;
      color: #fff;
      border: 1px solid #444;
    }
    button {
      background: #ff8800;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }
    .box {
      background: #111;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    canvas {
      width: 100% !important;
      height: auto !important;
    }
    #countdown {
      font-size: 14px;
      color: #ccc;
      margin-top: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìÉ Player Tax Portal</h1>

    <div id="bankForm" class="box">
      <input id="bankUser" placeholder="Enter Bank Username">
      <input id="bankID" placeholder="Enter Bank ID">
      <input id="bankPass" placeholder="Enter Bank Password">
      <button onclick="verifyBankLogin()">Login / Create Bank Account</button>
    </div>

    <div id="taxSection" style="display:none">
      <div id="profile" class="box"></div>
      <div class="box" id="historyBox"></div>
      <canvas id="taxChart"></canvas>
      <div id="countdown"></div>
    </div>
  </div>

<script>
const taxSyncURL = "https://syncs.1987sakshamsingh.workers.dev/";
const bankSyncURL = "https://b-syncs.1987sakshamsingh.workers.dev/";
const taxDataURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
const bankDataURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/bank-data.json";

let currentPlayer = "";
let paymentHistory = {}, paidPlayers = {}, dailyData = {}, chart;

async function verifyBankLogin() {
  const user = document.getElementById('bankUser').value.trim();
  const id = document.getElementById('bankID').value.trim();
  const pass = document.getElementById('bankPass').value.trim();
  currentPlayer = user;
  
  if (!user || !id || !pass) return alert("Fill all bank fields");
  try {
    const res = await fetch(bankDataURL);
    const data = await res.json();
    const accounts = data.accounts || {};

    if (!accounts[user]) {
      accounts[user] = { username: user, id, password: pass };
      await syncToCloudflare(bankSyncURL, { accounts });
      alert("‚úÖ Bank Account Created");
    } else if (accounts[user].id !== id || accounts[user].password !== pass) {
      return alert("‚ùå Incorrect Bank Details");
    }
    document.getElementById("bankForm").style.display = "none";
    document.getElementById("taxSection").style.display = "block";
    loadOnlineData();
  } catch {
    alert("Could not load tax/bank data.");
  }
}

async function loadOnlineData() {
  const res = await fetch(taxDataURL);
  const data = await res.json();
  paidPlayers = data.paidPlayers || {};
  paymentHistory = data.paymentHistory || {};
  await loadTax();
}

async function loadTax() {
  const res = await fetch("transaction-log.txt");
  const text = await res.text();
  parseTransactions(text);
}

function parseTransactions(log) {
  const lines = log.split(/\r?\n/);
  let buy = 0, sell = 0;
  dailyData = {};
  lines.forEach(line => {
    if (!line.includes(currentPlayer)) return;
    const date = line.match(/\[(\d{4}-\d{2}-\d{2})/);
    const day = date ? date[1].slice(5).replace('-', '/') : "";
    const buyMatch = line.match(/bought.*?\$(\d[\d,.]*)/);
    const sellMatch = line.match(/sold.*?\$(\d[\d,.]*)/);
    if (buyMatch) {
      const amt = parseFloat(buyMatch[1].replace(/,/g, ""));
      const tax = +(amt * 0.04).toFixed(2);
      buy += tax;
      dailyData[day] = (dailyData[day] || 0) + tax;
    }
    if (sellMatch) {
      const amt = parseFloat(sellMatch[1].replace(/,/g, ""));
      const tax = +(amt * 0.10).toFixed(2);
      sell += tax;
      dailyData[day] = (dailyData[day] || 0) + tax;
    }
  });

  const total = buy + sell;
  const paid = (paymentHistory[currentPlayer] || []).reduce((s, e) => s + e.amount, 0);
  const due = Math.max(0, total - paid);
  const advanced = paid > total;

  showProfile(buy, sell, total, paid, due, advanced);
  renderChart();
}

function showProfile(buy, sell, total, paid, due, advanced) {
  const box = document.getElementById("profile");
  box.innerHTML = `<h3>Welcome, ${currentPlayer}</h3>
    <p>Total Tax: $${total.toFixed(2)}</p>
    <p>Buying Tax: $${buy.toFixed(2)} | Selling Tax: $${sell.toFixed(2)}</p>
    <p>Status: <strong>${due === 0 ? (advanced ? "Advance Paid" : "No Tax Due") : "$" + due.toFixed(2) + " Due"}</strong></p>
    <input type="number" id="payAmt" placeholder="Enter amount to pay">
    <div class="btn-row">
      ${due > 0 ? `<button onclick="submitTax()">Pay Tax</button>` : ``}
      ${due === 0 ? `<button onclick="submitTax()">Advance Pay</button>` : ``}
    </div>`;

  const history = paymentHistory[currentPlayer] || [];
  const shown = history.slice(-5);
  const histBox = document.getElementById("historyBox");
  histBox.innerHTML = `<h3>Payment History</h3><ul>
    ${shown.map(e => `<li>$${e.amount} on ${e.date}</li>`).join('')}
  </ul>
  ${history.length > 5 ? '<button onclick="alert(\'See full transaction soon...\')">See Full Transaction</button>' : ''}`;
}

function submitTax() {
  const amt = parseFloat(document.getElementById("payAmt").value);
  if (!amt || amt <= 0) return alert("Invalid amount");
  const entry = { amount: amt, date: new Date().toLocaleString() };
  if (!paymentHistory[currentPlayer]) paymentHistory[currentPlayer] = [];
  paymentHistory[currentPlayer].push(entry);
  const paid = paymentHistory[currentPlayer].reduce((s, e) => s + e.amount, 0);

  syncToCloudflare(taxSyncURL, {
    paidPlayers: { [currentPlayer]: paid },
    paymentHistory: { [currentPlayer]: paymentHistory[currentPlayer] }
  });

  document.getElementById("countdown").innerText = "üíæ Your payment will save in 5 minutes. You can leave the website now.";
  let time = 300;
  const interval = setInterval(() => {
    time--;
    if (time <= 0) {
      clearInterval(interval);
      document.getElementById("countdown").innerText = "‚úÖ Payment saved.";
    } else {
      document.getElementById("countdown").innerText = `üíæ Your payment will save in 5 minutes. ${Math.floor(time / 60)}m ${time % 60}s remaining.`;
    }
  }, 1000);

  loadTax();
}

function renderChart() {
  const ctx = document.getElementById("taxChart").getContext("2d");
  const labels = Object.keys(dailyData);
  const values = Object.values(dailyData);
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{ label: "Daily Tax", data: values, borderColor: '#ffcc00', fill: false }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `$${ctx.raw.toFixed(2)}` } } },
      scales: {
        x: { title: { display: true, text: "Date" } },
        y: { title: { display: true, text: "Tax ($)" } }
      }
    }
  });
}

async function syncToCloudflare(url, data) {
  try {
    await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
  } catch (e) {
    console.warn("‚òÅÔ∏è Sync Error:", e);
  }
}
</script>
</body>
</html>
