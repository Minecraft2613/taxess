<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸ’¼ Player Tax Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f0f0f, #1e1e1e);
      color: #fff;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    h1 { text-align: center; color: #ffcc00; }
    input, select, button {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 6px;
      border: none;
    }
    input, select {
      background: #222;
      color: #fff;
      border: 1px solid #444;
    }
    button {
      background: #ff8800;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }
    .box {
      background: #111;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
    }
    .btn-row { display: flex; flex-wrap: wrap; gap: 10px; }
    canvas { width: 100% !important; height: auto !important; }
    .countdown { color: #0f0; font-weight: bold; text-align: center; margin-top: 10px; }
  </style>
</head>
<body>
<div class="container">
  <h1>ðŸ“ƒ Player Tax Portal</h1>
  <div id="loginBox" class="box">
    <input id="mcid" placeholder="Minecraft Username" />
    <select id="job"></select>
    <select id="method">
      <option value="Discord">Discord</option>
      <option value="Instagram">Instagram</option>
    </select>
    <input id="contact" placeholder="Contact Username" />
    <button onclick="checkTax()">Check Tax</button>
  </div>

  <div id="bankBox" class="box" style="display:none;"></div>
  <div id="profileBox" class="box" style="display:none;"></div>
  <div id="historyBox" class="box" style="display:none;"></div>
  <div class="countdown" id="saveNotice" style="display:none;"></div>
  <canvas id="taxChart" style="display:none;"></canvas>
</div>

<script>
const taxURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
const bankURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/bank-data.json";
const syncTaxURL = "https://syncs.1987sakshamsingh.workers.dev/";
const syncBankURL = "https://b-syncs.1987sakshamsingh.workers.dev/";
const syncTransactionURL = "https://transaction.1987sakshamsingh.workers.dev/";

let paidPlayers = {}, paymentHistory = {}, bankAccounts = {};
let currentPlayer = '', dailyData = {}, chart;

function sumPayments(player) {
  const history = paymentHistory[player] || [];
  return history.reduce((sum, e) => sum + Number(e.amount), 0);
}

async function checkTax() {
  currentPlayer = document.getElementById('mcid').value.trim();
  if (!currentPlayer) return alert("Enter Minecraft Username");
  document.getElementById("loginBox").style.display = "none";
  try { await fetch(syncTransactionURL, { method: "POST" }); } catch {}
  await loadOnlineData();
  if (!bankAccounts[currentPlayer]) showBankCreate();
  else showBankLogin();
}

function showBankCreate() {
  document.getElementById("bankBox").innerHTML = `
    <h3>Create Bank Account</h3>
    <input id="bankUser" placeholder="Username" />
    <input id="bankId" placeholder="ID" />
    <input id="bankPass" type="password" placeholder="Password" />
    <button onclick="createBankAccount()">Create</button>`;
  document.getElementById("bankBox").style.display = "block";
}

function showBankLogin() {
  document.getElementById("bankBox").innerHTML = `
    <h3>Bank Login</h3>
    <input id="bankId" placeholder="ID" />
    <input id="bankPass" type="password" placeholder="Password" />
    <button onclick="verifyBankLogin()">Login</button>`;
  document.getElementById("bankBox").style.display = "block";
}

async function loadOnlineData() {
  const tax = await fetch(taxURL).then(r => r.json());
  const bank = await fetch(bankURL).then(r => r.json());
  paidPlayers = tax.paidPlayers || {};
  paymentHistory = tax.paymentHistory || {};
  bankAccounts = bank.accounts || {};
}

function verifyBankLogin() {
  const id = document.getElementById("bankId").value;
  const pass = document.getElementById("bankPass").value;
  const acc = bankAccounts[currentPlayer];
  if (acc && acc.id === id && acc.password === pass) {
    document.getElementById("bankBox").style.display = "none";
    loadTax();
  } else alert("Invalid Credentials");
}

function createBankAccount() {
  const username = document.getElementById("bankUser").value;
  const id = document.getElementById("bankId").value;
  const pass = document.getElementById("bankPass").value;
  if (!username || !id || !pass) return alert("Fill all fields");
  bankAccounts[currentPlayer] = { username, id, password: pass };
  syncToCloudflare(syncBankURL, { accounts: bankAccounts });
  document.getElementById("bankBox").style.display = "none";
  loadTax();
}

async function loadTax() {
  const res = await fetch("https://raw.githubusercontent.com/Minecraft2613/taxess/main/transaction-log.txt?nocache=" + Date.now());
  const log = await res.text();
  parseTransactions(log);
}

function parseTransactions(log) {
  const lines = log.split(/\r?\n/);
  let buy = 0, sell = 0;
  dailyData = {};
  lines.forEach(line => {
    if (!line.toLowerCase().includes(currentPlayer.toLowerCase())) return;
    const date = line.match(/\[(\d{4}-\d{2}-\d{2})/);
    const day = date ? date[1].slice(5).replace('-', '/') : "";
    const buyMatch = line.match(/bought.*?\$(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/);
    const sellMatch = line.match(/sold.*?\$(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/);
    if (buyMatch) {
      const amt = parseFloat(buyMatch[1].replace(/,/g, ""));
      const tax = +(amt * 0.04).toFixed(2);
      buy += tax;
      dailyData[day] = (dailyData[day] || 0) + tax;
    }
    if (sellMatch) {
      const amt = parseFloat(sellMatch[1].replace(/,/g, ""));
      const tax = +(amt * 0.10).toFixed(2);
      sell += tax;
      dailyData[day] = (dailyData[day] || 0) + tax;
    }
  });
  const total = buy + sell;
  const paid = sumPayments(currentPlayer);
  const due = Math.max(0, total - paid);
  const advanced = paid > total;
  showProfile(buy, sell, total, paid, due, advanced);
  renderChart();
}

function showProfile(buy, sell, total, paid, due, advanced) {
  document.getElementById("profileBox").innerHTML = `
    <h3>${currentPlayer}</h3>
    <p>Total Tax: $${total.toFixed(2)}</p>
    <p>Buy: $${buy.toFixed(2)}, Sell: $${sell.toFixed(2)}</p>
    <p>Status: <b>${due === 0 ? (advanced ? "Advance Paid" : "No Due") : "$" + due.toFixed(2) + " Due"}</b></p>
    <input type="number" id="payAmt" placeholder="Amount to Pay">
    <div class="btn-row">
      <button onclick="submitTax()">${due > 0 ? "Pay Tax" : "Advance Pay"}</button>
    </div>`;
  document.getElementById("profileBox").style.display = "block";
  const history = paymentHistory[currentPlayer] || [];
  const last = history.slice(-5);
  document.getElementById("historyBox").innerHTML = `<h3>History</h3><ul>
    ${last.map(e => `<li>$${e.amount} on ${e.date}</li>`).join('')}</ul>`;
  document.getElementById("historyBox").style.display = "block";
}

function submitTax() {
  const amt = parseFloat(document.getElementById("payAmt").value);
  if (!amt || amt <= 0) return alert("Invalid amount");
  const entry = { amount: amt, date: new Date().toLocaleString() };
  if (!paymentHistory[currentPlayer]) paymentHistory[currentPlayer] = [];
  paymentHistory[currentPlayer].push(entry);
  paidPlayers[currentPlayer] = sumPayments(currentPlayer);
  syncToCloudflare(syncTaxURL, { paidPlayers, paymentHistory });
  showCountdown();
  loadTax();
}

function syncToCloudflare(url, data) {
  fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
}

function showCountdown() {
  let t = 300;
  const el = document.getElementById("saveNotice");
  el.style.display = "block";
  const interval = setInterval(() => {
    if (--t <= 0) {
      clearInterval(interval);
      el.innerText = "âœ… Data saved.";
    } else {
      const m = Math.floor(t / 60), s = t % 60;
      el.innerText = `Auto-save in ${m}:${s.toString().padStart(2, '0')}`;
    }
  }, 1000);
}

function renderChart() {
  const ctx = document.getElementById('taxChart');
  document.getElementById('taxChart').style.display = "block";
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: Object.keys(dailyData),
      datasets: [{
        label: 'Daily Tax ($)',
        data: Object.values(dailyData),
        borderColor: '#ffcc00',
        backgroundColor: 'rgba(255, 204, 0, 0.2)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true },
        x: { ticks: { color: '#fff' } }
      }
    }
  });
}

window.onload = () => {
  document.getElementById("job").innerHTML = ["Farmer", "Miner", "Trader", "Builder"]
    .map(j => `<option>${j}</option>`).join("");
};
</script>
</body>
</html>
