<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üíº Player Tax Portal</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f0f0f, #1e1e1e);
      color: #fff;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #ffcc00;
    }
    input, select, button {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 6px;
      border: none;
    }
    input, select {
      background: #222;
      color: #fff;
      border: 1px solid #444;
    }
    button {
      background: #ff8800;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }
    .profile-box, .history-box {
      background: #111;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    canvas {
      width: 100% !important;
      max-width: 100%;
      height: auto !important;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>üìÉ Player Tax Portal</h1>

  <div id="step1">
    <select id="job">
      <option>Farmer</option><option>Miner</option><option>Builder</option><option>Trader</option>
    </select>
    <input id="contact" placeholder="Enter your Discord/Instagram username" />
    <input id="mcid" placeholder="Enter your Minecraft Username" />
    <button onclick="nextStep()">Check Tax</button>
  </div>

  <div id="profile" class="profile-box" style="display:none;"></div>
  <div class="history-box" id="historyBox" style="display:none;"></div>
  <canvas id="taxChart" style="display:none;"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const GITHUB_TOKEN = "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"; // ‚¨ÖÔ∏è Replace this
const REPO_OWNER = "Minecraft2613";
const REPO_NAME = "taxess";
const FILE_PATH = "tax-data.json";
const BRANCH = "main";

let paidPlayers = {}, paymentHistory = {}, currentPlayer = "", dailyData = {}, chart = null;

async function nextStep() {
  const contact = document.getElementById('contact').value.trim();
  const mcid = document.getElementById('mcid').value.trim();
  if (!mcid || !contact) return alert("Please fill all fields");
  currentPlayer = mcid;

  document.getElementById("step1").style.display = "none";
  await loadGitHubData();
  await loadTaxLog();
}

async function loadGitHubData() {
  try {
    const res = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${FILE_PATH}`);
    const json = await res.json();
    paidPlayers = json.paidPlayers || {};
    paymentHistory = json.paymentHistory || {};
  } catch (err) {
    console.warn("Fallback to local");
    paidPlayers = {};
    paymentHistory = {};
  }
}

async function loadTaxLog() {
  try {
    const res = await fetch("transaction-log.txt");
    const text = await res.text();
    parseTransactions(text);
  } catch {
    alert("Failed to load transaction log.");
  }
}

function parseTransactions(log) {
  const lines = log.split(/\r?\n/);
  let buy = 0, sell = 0;
  dailyData = {};

  lines.forEach(line => {
    if (!line.includes(currentPlayer)) return;
    const date = line.match(/\[(\d{4}-\d{2}-\d{2})/);
    const day = date ? date[1].slice(5).replace('-', '/') : "";

    const buyMatch = line.match(/bought.*?\$([\d,]+\.\d{2})/);
    const sellMatch = line.match(/sold.*?\$([\d,]+\.\d{2})/);

    if (buyMatch) {
      const amt = parseFloat(buyMatch[1].replace(/,/g, ""));
      const tax = +(amt * 0.04).toFixed(2);
      buy += tax;
      dailyData[day] = (dailyData[day] || 0) + tax;
    }
    if (sellMatch) {
      const amt = parseFloat(sellMatch[1].replace(/,/g, ""));
      const tax = +(amt * 0.10).toFixed(2);
      sell += tax;
      dailyData[day] = (dailyData[day] || 0) + tax;
    }
  });

  const total = buy + sell;
  const paid = paidPlayers[currentPlayer] || 0;
  const due = Math.max(0, total - paid);
  const advanced = paid > total;

  showProfile(buy, sell, total, paid, due, advanced);
  renderChart();
}

function showProfile(buy, sell, total, paid, due, advanced) {
  const box = document.getElementById("profile");
  box.innerHTML = `<h3>Welcome, ${currentPlayer}</h3>
    <p>Total Tax: $${total.toFixed(2)}</p>
    <p>Buying Tax: $${buy.toFixed(2)} | Selling Tax: $${sell.toFixed(2)}</p>
    <p>Status: <strong>${due === 0 ? (advanced ? "Advance Paid" : "No Tax Due") : "$" + due.toFixed(2) + " Due"}</strong></p>
    <input type="number" id="payAmt" placeholder="Enter amount to pay">
    <div class="btn-row">
      ${due > 0 ? `<button onclick="submitTax()">Pay Tax</button>` : ``}
      ${due === 0 ? `<button onclick="advancePay()">Advance Pay</button>` : ``}
      <button onclick="exit()">Exit</button>
    </div>`;
  box.style.display = "block";

  const history = paymentHistory[currentPlayer] || [];
  const histBox = document.getElementById("historyBox");
  histBox.innerHTML = `<h3>Payment History</h3><ul>${history.map(e => `<li>$${e.amount} on ${e.date}</li>`).join('')}</ul>`;
  histBox.style.display = "block";
}

function submitTax() {
  const amt = parseFloat(document.getElementById("payAmt").value);
  if (!amt || amt <= 0) return alert("Invalid amount");
  paidPlayers[currentPlayer] = (paidPlayers[currentPlayer] || 0) + amt;
  recordPayment(amt);
  saveToGitHub();
  loadTaxLog();
}

function advancePay() {
  submitTax();
}

function recordPayment(amt) {
  const entry = { amount: amt, date: new Date().toLocaleString() };
  if (!paymentHistory[currentPlayer]) paymentHistory[currentPlayer] = [];
  paymentHistory[currentPlayer].push(entry);
}

function renderChart() {
  const ctx = document.getElementById("taxChart").getContext("2d");
  const labels = Object.keys(dailyData);
  const values = Object.values(dailyData);

  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: "Daily Tax",
        data: values,
        borderColor: '#ffcc00',
        fill: false,
        tension: 0.3,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: ctx => `$${ctx.raw.toFixed(2)}` } }
      },
      scales: {
        x: { title: { display: true, text: "Date" } },
        y: { title: { display: true, text: "Tax ($)" } }
      }
    }
  });
  document.getElementById("taxChart").style.display = "block";
}

async function saveToGitHub() {
  const content = {
    paidPlayers,
    paymentHistory
  };
  const fileContent = btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2))));

  const shaRes = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
    headers: { Authorization: `Bearer ${GITHUB_TOKEN}` }
  });
  const shaData = await shaRes.json();
  const currentSha = shaData.sha;

  const result = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
    method: "PUT",
    headers: {
      "Authorization": `Bearer ${GITHUB_TOKEN}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Update tax-data.json",
      content: fileContent,
      sha: currentSha,
      branch: BRANCH
    })
  });

  if (result.ok) {
    console.log("‚úÖ Saved to GitHub");
  } else {
    alert("‚ùå Failed to save: " + (await result.text()));
  }
}

function exit() {
  document.getElementById("step1").style.display = "block";
  document.getElementById("profile").style.display = "none";
  document.getElementById("historyBox").style.display = "none";
  document.getElementById("taxChart").style.display = "none";
  document.getElementById("contact").value = "";
  document.getElementById("mcid").value = "";
}
</script>
</body>
</html>
