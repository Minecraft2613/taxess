<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>📄 Player Tax Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f0f0f, #1e1e1e);
      color: #fff;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    h1 {
      text-align: center;
      color: #ffcc00;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { color: #ffcc00; }
      50% { color: #ff8800; }
    }
    .main {
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    .card {
      background: #111;
      padding: 20px;
      margin: 20px 0;
      border-radius: 10px;
      box-shadow: 0 0 10px #ff880088;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-size: 16px;
    }
    input, select {
      background: #222;
      color: #fff;
      border: 1px solid #444;
    }
    button {
      background: #ff8800;
      color: #000;
      border: none;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    .loading {
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      margin-top: 30px;
    }
    .loading .block {
      width: 20px;
      height: 20px;
      background: #ff8800;
      margin: 5px;
      animation: bounce 1.2s infinite ease-in-out;
    }
    .loading .block:nth-child(2) { animation-delay: 0.2s; }
    .loading .block:nth-child(3) { animation-delay: 0.4s; }
    .loading .block:nth-child(4) { animation-delay: 0.6s; }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    #taxChart {
      width: 100%;
      max-height: 300px;
    }
    .theme-toggle {
      text-align: right;
      margin: -10px 0 10px;
    }
    #countdownTimer {
      text-align: center;
      font-weight: bold;
      margin: 10px auto;
      color: #ff5555;
    }
  </style>
</head>
<body>
  <div class="main">
    <div class="theme-toggle">
      <label><input type="checkbox" id="themeToggle" /> Light Mode</label>
    </div>
    <h1>📄 <span class="glow">Player Tax Portal</span></h1>

    <div id="step1" class="card">
      <select id="version">
        <option>Java</option>
        <option>Bedrock</option>
      </select>
      <select id="method">
        <option>Discord</option>
        <option>Instagram</option>
      </select>
      <input id="mcid" placeholder="Minecraft Name" />
      <input id="contactId" placeholder="Your Discord or Insta Name" />
      <button onclick="checkTax()">Next</button>
    </div>

    <div id="loading" class="loading">
      <div class="block"></div>
      <div class="block"></div>
      <div class="block"></div>
      <div class="block"></div>
      <p>Loading data...</p>
    </div>

    <div id="bankBox" class="card" style="display:none;"></div>
    <div id="countdownTimer" style="display:none;"></div>
    <div id="profile" class="card" style="display:none;"></div>
    <div id="historyBox" class="card" style="display:none;"></div>
    <div id="fullHistoryBox" class="card" style="display:none;"></div>
    <div id="chartArea" class="card" style="display:none;">
      <canvas id="taxChart"></canvas>
      <div class="btn-row">
        <button onclick="changeChart('bar')">Bar</button>
        <button onclick="changeChart('line')">Line</button>
        <button onclick="changeChart('pie')">Pie</button>
        <button onclick="downloadChart()">Export</button>
        <button onclick="downloadHistory()">Export History</button>
        <button onclick="exitApp()">Exit</button>
      </div>
    </div>
  </div>

  <script>
    const webhookURL = "https://discordapp.com/api/webhooks/1386366777403117620/ioXKz_sPozMCx1DPvTWnJ1d2YyBw9P9oiqoRO_EWJWRZ1YDFEQEK3R64Y5RImfIgTrHR";
    const transactionURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/transaction-log.txt";
    const countdownDays = 7;

    let paymentHistory = {}, paidPlayers = {}, currentPlayer = "", chartType = "bar", chart, dailyData = {}, deadline = null;

    function checkTax() {
      currentPlayer = document.getElementById("mcid").value.trim();
      const contact = document.getElementById("contactId").value.trim();
      if (!currentPlayer || !contact) return alert("Fill in both Minecraft and Discord/Insta name");
      document.getElementById("step1").style.display = "none";
      document.getElementById("loading").style.display = "flex";
      sendDiscordWebhook(currentPlayer, contact);
      loadTaxData();
    }

    function sendDiscordWebhook(player, contact) {
      fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: `📝 ${player} accessed the portal\n📨 Contact: ${contact}` })
      });
    }

    async function loadTaxData() {
      try {
        const res = await fetch(transactionURL + "?nocache=" + Date.now());
        const text = await res.text();
        parseTransactions(text);
        document.getElementById("loading").style.display = "none";
        showProfile();
        startCountdown();
      } catch {
        alert("Failed to load tax data.");
        location.reload();
      }
    }

    function parseTransactions(log) {
      const lines = log.split("\n");
      let buy = 0, sell = 0;
      dailyData = {};
      lines.forEach(line => {
        if (!line.toLowerCase().includes(currentPlayer.toLowerCase())) return;
        const matchDate = line.match(/\[(\d{4}-\d{2}-\d{2})/);
        const day = matchDate ? matchDate[1].slice(5).replace("-", "/") : "";
        const buyMatch = line.match(/bought.*?\$(\d[\d,.]+)/);
        const sellMatch = line.match(/sold.*?\$(\d[\d,.]+)/);
        if (buyMatch) {
          const amt = parseFloat(buyMatch[1].replace(/,/g, ""));
          const tax = +(amt * 0.04).toFixed(2);
          buy += tax;
          dailyData[day] = (dailyData[day] || 0) + tax;
        }
        if (sellMatch) {
          const amt = parseFloat(sellMatch[1].replace(/,/g, ""));
          const tax = +(amt * 0.10).toFixed(2);
          sell += tax;
          dailyData[day] = (dailyData[day] || 0) + tax;
        }
      });
      deadline = Date.now() + countdownDays * 24 * 60 * 60 * 1000;
    }

    function startCountdown() {
      const timer = document.getElementById("countdownTimer");
      timer.style.display = "block";
      function update() {
        const now = Date.now();
        const diff = deadline - now;
        if (diff <= 0) {
          timer.textContent = "⚠️ Tax Deadline Missed!";
          return;
        }
        const d = Math.floor(diff / 86400000),
              h = Math.floor((diff % 86400000) / 3600000),
              m = Math.floor((diff % 3600000) / 60000);
        timer.textContent = `⏳ Tax Deadline: ${d}d ${h}h ${m}m left`;
        setTimeout(update, 60000);
      }
      update();
    }

    function showProfile() {
      const total = Object.values(dailyData).reduce((a,b)=>a+b,0);
      const paid = 0;
      const due = Math.max(0, total - paid);
      paymentHistory[currentPlayer] = [];

      document.getElementById("profile").innerHTML = `
        <h3>Welcome, ${currentPlayer}</h3>
        <p>Total Tax: $${total.toFixed(2)}</p>
        <p>Status: <strong>${due === 0 ? "No Tax Due" : "$" + due.toFixed(2) + " Due"}</strong></p>
        <input type="number" id="payAmt" placeholder="Enter amount to pay" min="1" />
        <div class="btn-row">
          <button onclick="submitTax()">${due > 0 ? "Pay Tax" : "Advance Pay"}</button>
          <button onclick="showFullHistory()">Full History</button>
          <button onclick="exitApp()">Exit</button>
        </div>`;
      document.getElementById("profile").style.display = "block";
      renderChart();
    }

    function renderChart() {
      const ctx = document.getElementById("taxChart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: chartType,
        data: {
          labels: Object.keys(dailyData),
          datasets: [{
            label: "Tax Per Day",
            data: Object.values(dailyData),
            backgroundColor: chartType === "pie" ? ['#ffaa00', '#ff8800', '#ff6600', '#00ffaa'] : '#00ffaa',
            borderColor: '#00ffaa',
            borderWidth: 2,
            fill: chartType !== 'pie',
            tension: 0,
            pointRadius: 3,
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#fff' } } },
          scales: chartType === 'pie' ? {} : {
            x: { ticks: { color: '#ccc' }, grid: { color: '#333' } },
            y: { beginAtZero: true, ticks: { color: '#ccc' }, grid: { color: '#333' } }
          }
        }
      });
      document.getElementById("chartArea").style.display = "block";
    }

    function changeChart(type) {
      chartType = type;
      renderChart();
    }

    function downloadChart() {
      const link = document.createElement("a");
      link.download = `${currentPlayer}-tax-chart.png`;
      link.href = document.getElementById("taxChart").toDataURL("image/png");
      link.click();
    }

    function downloadHistory() {
      const entries = paymentHistory[currentPlayer] || [];
      const content = `Player: ${currentPlayer}\n` + entries.map(e => `Paid $${e.amount} on ${e.date}`).join("\n");
      const blob = new Blob([content], { type: "text/plain" });
      const link = document.createElement("a");
      link.download = `${currentPlayer}-tax-history.txt`;
      link.href = URL.createObjectURL(blob);
      link.click();
    }

    function submitTax() {
      const amt = parseFloat(document.getElementById("payAmt").value);
      if (!amt || amt <= 0) return alert("Invalid amount");
      const entry = { amount: amt, date: new Date().toLocaleString() };
      paymentHistory[currentPlayer].push(entry);
      alert("✅ Tax submitted successfully!");
    }

    function showFullHistory() {
      const all = paymentHistory[currentPlayer] || [];
      document.getElementById("fullHistoryBox").innerHTML = `<h3>Full Payment History</h3><ul>
        ${all.map(e => `<li>$${e.amount} on ${e.date}</li>`).join('')}</ul>`;
      document.getElementById("fullHistoryBox").style.display = "block";
    }

    function exitApp() {
      location.reload();
    }

    document.getElementById("themeToggle").addEventListener("change", e => {
      if (e.target.checked) {
        document.body.style.background = "#f4f4f4";
        document.body.style.color = "#111";
      } else {
        document.body.style.background = "linear-gradient(135deg, #0f0f0f, #1e1e1e)";
        document.body.style.color = "#fff";
      }
    });
  </script>
</body>
</html>
