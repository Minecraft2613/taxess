<!-- ‚úÖ Secure Player Tax Portal with Unique Bank Account Verification -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure Player Tax Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #111; color: #fff; margin: 0; padding: 0; }
    .container { max-width: 800px; margin: auto; padding: 20px; }
    input, select, button {
      display: block; width: 100%; padding: 10px; margin: 10px 0;
      font-size: 16px; border-radius: 6px; border: none;
    }
    input, select { background: #222; color: #fff; border: 1px solid #555; }
    button { background: orange; color: black; font-weight: bold; cursor: pointer; }
    .profile-box, .history-box { background: #1b1b1b; padding: 15px; border-radius: 10px; margin-top: 20px; }
    canvas { width: 100% !important; height: auto !important; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000a; z-index:1000; justify-content:center; align-items:center; }
    .modal-content { background:#222; padding:20px; border-radius:10px; width:90%; max-width:400px; }
  </style>
</head>
<body>
<div class="container">
  <h1>Secure üíº Player Tax Portal</h1>
  <div id="step1">
    <select id="job"></select>
    <input id="contact" placeholder="Discord/Instagram Username" />
    <input id="mcid" placeholder="Minecraft Username" />
    <button onclick="checkTax()">Check Tax</button>
  </div>
  <div id="profile" class="profile-box" style="display:none;"></div>
  <div class="history-box" id="historyBox" style="display:none;"></div>
  <canvas id="taxChart" style="display:none;"></canvas>
</div>

<!-- Bank Modal -->
<div id="bankModal" class="modal">
  <div class="modal-content">
    <h3 id="bankTitle">üîê Bank Verification</h3>
    <input id="bankUser" placeholder="Bank Username" />
    <input id="bankId" placeholder="Bank ID" />
    <input id="bankPass" placeholder="Bank Password" type="password" />
    <button onclick="verifyBank()">‚úÖ Proceed</button>
    <button onclick="closeBankModal()">‚ùå Cancel</button>
  </div>
</div>

<script>
const jsonDataURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
const syncURL = "https://syncs.1987sakshamsingh.workers.dev/";
let paidPlayers = {}, paymentHistory = {}, bankData = {}, currentPlayer = '', dailyData = {}, chart;
let pendingAmount = 0, isBankVerified = false;

function sumPayments(player) {
  const history = paymentHistory[player] || [];
  return history.reduce((sum, entry) => sum + entry.amount, 0);
}

async function checkTax() {
  const contact = document.getElementById('contact').value.trim();
  const mcid = document.getElementById('mcid').value.trim();
  if (!mcid || !contact) return alert("Please fill all fields");
  currentPlayer = mcid;
  document.getElementById("step1").style.display = "none";
  await loadOnlineData();
  await loadTax();
}

async function loadOnlineData() {
  const res = await fetch(jsonDataURL);
  const data = await res.json();
  paidPlayers = data.paidPlayers || {};
  paymentHistory = data.paymentHistory || {};
  bankData = data.bankData || {};
}

async function loadTax() {
  const res = await fetch("transaction-log.txt");
  const text = await res.text();
  parseTransactions(text);
}

function parseTransactions(log) {
  const lines = log.split("\n");
  let buy = 0, sell = 0;
  dailyData = {};
  lines.forEach(line => {
    if (!line.includes(currentPlayer)) return;
    const date = line.match(/\[(\d{4}-\d{2}-\d{2})/);
    const day = date ? date[1].slice(5).replace('-', '/') : "";
    const buyMatch = line.match(/bought.*?\$([\d,]+\.\d{2})/);
    const sellMatch = line.match(/sold.*?\$([\d,]+\.\d{2})/);
    if (buyMatch) {
      const amt = parseFloat(buyMatch[1].replace(/,/g, ""));
      const tax = +(amt * 0.04).toFixed(2);
      buy += tax;
      dailyData[day] = (dailyData[day] || 0) + tax;
    }
    if (sellMatch) {
      const amt = parseFloat(sellMatch[1].replace(/,/g, ""));
      const tax = +(amt * 0.10).toFixed(2);
      sell += tax;
      dailyData[day] = (dailyData[day] || 0) + tax;
    }
  });
  const total = buy + sell;
  const paid = sumPayments(currentPlayer);
  const due = Math.max(0, total - paid);
  const advanced = paid > total;
  showProfile(buy, sell, total, paid, due, advanced);
  renderChart();
}

function showProfile(buy, sell, total, paid, due, advanced) {
  const box = document.getElementById("profile");
  box.innerHTML = `<h3>Welcome, ${currentPlayer}</h3>
    <p>Total Tax: $${total.toFixed(2)}</p>
    <p>Buying Tax: $${buy.toFixed(2)} | Selling Tax: $${sell.toFixed(2)}</p>
    <p>Status: <strong>${due === 0 ? (advanced ? "Advance Paid" : "No Tax Due") : "$" + due.toFixed(2) + " Due"}</strong></p>
    <input type="number" id="payAmt" placeholder="Enter amount to pay">
    <button onclick="preparePayment()">Pay Tax</button>
    <button onclick="exit()">Exit</button>`;
  box.style.display = "block";

  const history = paymentHistory[currentPlayer] || [];
  document.getElementById("historyBox").innerHTML = `<h3>Payment History</h3><ul>${history.map(e => `<li>$${e.amount} on ${e.date}</li>`).join('')}</ul>`;
  document.getElementById("historyBox").style.display = "block";
}

function preparePayment() {
  pendingAmount = parseFloat(document.getElementById("payAmt").value);
  if (!pendingAmount || pendingAmount <= 0) return alert("Invalid amount");
  const bank = bankData[currentPlayer];
  document.getElementById("bankTitle").textContent = bank ? "üîê Login to Bank" : "üìù Create Bank Account";
  document.getElementById("bankUser").value = bank ? bank.bankUser : "";
  document.getElementById("bankId").value = bank ? bank.bankId : "";
  document.getElementById("bankPass").value = "";
  document.getElementById("bankModal").style.display = "flex";
}

function closeBankModal() {
  document.getElementById("bankModal").style.display = "none";
}

function verifyBank() {
  const user = document.getElementById("bankUser").value.trim();
  const id = document.getElementById("bankId").value.trim();
  const pass = document.getElementById("bankPass").value.trim();
  if (!user || !id || !pass) return alert("Fill all bank details");
  const bank = bankData[currentPlayer];
  if (bank) {
    if (bank.bankUser !== user || bank.bankPass !== pass) return alert("Incorrect bank credentials");
  } else {
    bankData[currentPlayer] = { bankUser: user, bankId: id, bankPass: pass };
  }
  recordPayment(pendingAmount);
  syncToCloudflare();
  closeBankModal();
}

function recordPayment(amt) {
  const entry = { amount: amt, date: new Date().toLocaleString() };
  if (!paymentHistory[currentPlayer]) paymentHistory[currentPlayer] = [];
  paymentHistory[currentPlayer].push(entry);
}

function syncToCloudflare() {
  const body = {
    paidPlayers: Object.fromEntries(Object.entries(paymentHistory).map(([k, v]) => [k, sumPayments(k)])),
    paymentHistory: paymentHistory,
    bankData: bankData
  };
  fetch(syncURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  }).then(res => res.ok ? alert("‚úÖ Synced") : res.text().then(txt => console.warn("‚ùå Sync error:", txt)));
}

function renderChart() {
  const ctx = document.getElementById("taxChart").getContext("2d");
  const labels = Object.keys(dailyData);
  const values = Object.values(dailyData);
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels: labels, datasets: [{ label: "Daily Tax", data: values, borderColor: '#ffcc00', fill: false }] },
    options: { responsive: true }
  });
  document.getElementById("taxChart").style.display = "block";
}

function exit() {
  document.getElementById("step1").style.display = "block";
  document.getElementById("profile").style.display = "none";
  document.getElementById("historyBox").style.display = "none";
  document.getElementById("taxChart").style.display = "none";
}

window.onload = () => {
  document.getElementById("job").innerHTML = ["Farmer", "Miner", "Trader"].map(j => `<option>${j}</option>`).join("");
};
</script>
</body>
</html>
