<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard | Player Tax Portal</title>
  <style>
    body { font-family: Arial; background: #111; color: #eee; padding: 20px; }
    h2 { color: gold; }
    button, input, textarea {
      padding: 6px; margin: 5px; border-radius: 4px; font-family: inherit;
    }
    input, textarea { width: 250px; background: #222; color: #fff; border: 1px solid #555; }
    button { background: gold; border: none; cursor: pointer; }
    button:hover { background: orange; }
    .section { margin-top: 20px; }
    .player { background: #1c1c1c; padding: 12px; border-radius: 6px; border: 1px solid #444; margin-bottom: 15px; }
  </style>
</head>
<body>

<h2>🔐 Admin Login</h2>
<input id="adminId" placeholder="Admin Bank ID">
<input id="adminPass" placeholder="Password" type="password">
<button onclick="adminLogin()">Login</button>

<div id="adminPanel" style="display:none;">
  <h2>🧾 Admin Panel</h2>
  <button onclick="showSection('bank')">🏦 Player Accounts</button>
  <button onclick="showSection('tax')">💸 Tax Panel</button>
  <button onclick="showSection('json')">📁 JSON Tools</button>
  <div id="bankSection" class="section"></div>
  <div id="taxSection" class="section" style="display:none;"></div>
  <div id="jsonSection" class="section" style="display:none;">
    <button onclick="downloadJSON('bank')">⬇️ Bank JSON</button>
    <button onclick="downloadJSON('tax')">⬇️ Tax JSON</button>
  </div>
</div>

<script>
const taxURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
const bankURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/bank-data.json";
const hookBase = "https://tax-hook.1987sakshamsingh.workers.dev";

let bankAccounts = {}, paidPlayers = {}, paymentHistory = {};

async function adminLogin() {
  const id = document.getElementById("adminId").value;
  const pass = document.getElementById("adminPass").value;
  const discord = prompt("Enter your Discord username");

  const res = await fetch("https://raw.githubusercontent.com/Minecraft2613/taxess/main/admin.json");
  const data = await res.json();
  const ip = await (await fetch("https://api64.ipify.org?format=json")).json();

  if (data.id === id && data.pass === pass && data.allowedDiscords.includes(discord) && data.allowedIps.includes(ip.ip)) {
    alert("✅ Logged in");
    document.getElementById("adminPanel").style.display = "block";
    loadAll();
  } else {
    alert("❌ Access Denied");
  }
}

async function loadAll() {
  const [bankRes, taxRes] = await Promise.all([fetch(bankURL), fetch(taxURL)]);
  bankAccounts = (await bankRes.json()).accounts || {};
  const taxData = await taxRes.json();
  paidPlayers = taxData.paidPlayers || {};
  paymentHistory = taxData.paymentHistory || {};
  showPlayerAccounts();
  showTaxPanel();
}

function showSection(name) {
  document.getElementById("bankSection").style.display = name === "bank" ? "block" : "none";
  document.getElementById("taxSection").style.display = name === "tax" ? "block" : "none";
  document.getElementById("jsonSection").style.display = name === "json" ? "block" : "none";
}

function showPlayerAccounts() {
  const box = document.getElementById("bankSection");
  box.innerHTML = `<h3>🏦 Player Bank Accounts</h3>`;
  for (let player in bankAccounts) {
    const acc = bankAccounts[player];
    box.innerHTML += `
      <div class="player">
        👤 <b>${player}</b><br>
        🆔 ID: <code>${acc.id}</code><br>
        🔐 Password: <code>${acc.password}</code><br>
        📛 Username: ${acc.username}<br>
        📞 Contact: ${acc.contact || "N/A"}
      </div>`;
  }
}

function showTaxPanel() {
  const box = document.getElementById("taxSection");
  box.innerHTML = `<h3>💰 Tax Overview</h3>`;
  for (let player in paidPlayers) {
    const paid = paidPlayers[player] || 0;
    const history = paymentHistory[player] || [];
    const total = history.reduce((sum, e) => sum + e.amount, 0);
    const due = Math.max(0, total - paid);
    box.innerHTML += `
      <div class="player">
        👤 <b>${player}</b><br>
        ✅ Paid: $${paid.toFixed(2)}<br>
        ❗ Due: $${due.toFixed(2)}<br>
        <button onclick="showPlayerHistory('${player}')">📖 View Payments</button>
        <br>
        <input id="amt-${player}" type="number" placeholder="Govt Pay Amount">
        <textarea id="desc-${player}" placeholder="Description (Reason)"></textarea><br>
        <button onclick="govtPay('${player}')">💸 Govt Pay</button>
      </div>`;
  }
}

function showPlayerHistory(player) {
  const history = paymentHistory[player] || [];
  alert(`📜 History for ${player}:\n\n` + history.map(e => `$${e.amount} on ${e.date}`).join("\n"));
}

function govtPay(player) {
  const amt = parseFloat(document.getElementById(`amt-${player}`).value);
  const desc = document.getElementById(`desc-${player}`).value;
  if (!amt || !desc) return alert("❌ Fill amount and reason");

  const entry = { amount: amt, date: new Date().toLocaleString(), admin: true, note: desc };
  if (!paymentHistory[player]) paymentHistory[player] = [];
  paymentHistory[player].unshift(entry);
  paidPlayers[player] = (paidPlayers[player] || 0) + amt;

  fetch(`${hookBase}?type=pay`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      content: `🏛️ **Govt Paid Tax**\n👤 Player: \`${player}\`\n💸 Amount: $${amt}\n📋 Reason: ${desc}`
    })
  });

  alert("✅ Paid as Government");
  showTaxPanel();
}

function downloadJSON(type) {
  const url = type === "bank" ? bankURL : taxURL;
  window.open(url, "_blank");
}
</script>
</body>
</html>
