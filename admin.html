<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🛠️ Admin Panel</title>
  <style>
    body { background: #111; color: #eee; font-family: Arial; padding: 20px; }
    input, button { padding: 8px; margin: 6px; font-size: 14px; border-radius: 4px; border: none; }
    input { background: #222; color: #fff; width: 250px; }
    button { background: gold; color: black; cursor: pointer; }
    button:hover { background: orange; }
    #topTaxPlayers ul { list-style: none; padding: 0; }
    #topTaxPlayers li { margin: 6px 0; }
    .btn-row button { margin-right: 10px; }
  </style>
</head>
<body>

  <div id="loginBox">
    <h2>🔐 Admin Login</h2>
    <input id="adminId" placeholder="Admin Bank ID" />
    <input id="adminPass" placeholder="Admin Password" type="password" />
    <button onclick="adminLogin()">Login</button>
  </div>

  <div id="profile" style="display:none;"></div>
  <div id="topTaxPlayers" style="display:none;"></div>

<script>
const taxURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
const bankURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/bank-data.json";
const syncTaxURL = "https://syncs.1987sakshamsingh.workers.dev/";
const syncBankURL = "https://b-syncs.1987sakshamsingh.workers.dev/";
const webhookURL = "https://tax-hook.1987sakshamsingh.workers.dev/?type=pay";

let paidPlayers = {}, paymentHistory = {}, bankAccounts = {}, taxDeadline = {}, totalTaxByPlayer = {};

async function adminLogin() {
  const id = document.getElementById("adminId").value.trim();
  const pass = document.getElementById("adminPass").value.trim();
  try {
    const res = await fetch("https://raw.githubusercontent.com/Minecraft2613/taxess/main/admin.json");
    const admin = await res.json();
    const discord = prompt("Enter your Discord username");

    if (id === admin.id && pass === admin.pass && admin.allowedDiscords.includes(discord)) {
      alert("✅ Admin Access Granted");
      document.getElementById("loginBox").style.display = "none";
      loadAllDataForAdmin();
    } else {
      alert("❌ Invalid admin credentials");
    }
  } catch (e) {
    console.error("Failed to load admin.json", e);
    alert("❌ Admin verification failed");
  }
}

async function loadAllDataForAdmin() {
  try {
    const [taxRes, bankRes, transRes] = await Promise.all([
      fetch(taxURL),
      fetch(bankURL),
      fetch("https://raw.githubusercontent.com/Minecraft2613/taxess/main/transaction-log.txt")
    ]);
    const taxData = await taxRes.json();
    const bankData = await bankRes.json();
    const logText = await transRes.text();

    calculateTotalTaxFromLog(logText);

    paidPlayers = taxData.paidPlayers || {};
    paymentHistory = taxData.paymentHistory || {};
    bankAccounts = bankData.accounts || {};
    taxDeadline = taxData.taxDeadline || {};

    const players = [...new Set([
      ...Object.keys(paidPlayers),
      ...Object.keys(paymentHistory),
      ...Object.keys(bankAccounts),
      ...(logText.match(/\] - ([a-zA-Z0-9_.]+) (bought|sold)/g)?.map(l => l.split(" - ")[1].split(" ")[0]) || [])
    ])];

    document.getElementById("profile").innerHTML = `
      <h2>🛠️ Admin Panel</h2>
      <p>Logged in as Admin</p>
      <div class="btn-row">
        <button onclick="syncTax()">💾 Sync Tax</button>
        <button onclick="syncBank()">💾 Sync Bank</button>
        <button onclick="location.reload()">🚪 Exit</button>
      </div>
    `;
    document.getElementById("profile").style.display = "block";

    document.getElementById("topTaxPlayers").innerHTML = `<h3>📋 All Players</h3><ul>${
      players.map(p => {
        const paid = (paymentHistory[p] || []).reduce((s, e) => s + Number(e.amount), 0);
        const total = totalTaxByPlayer[p] || 0;
        const due = Math.max(0, total - paid);
        return `<li><strong>${p}</strong> — Due: $${due.toFixed(2)} 
          <button onclick="viewPlayerAsAdmin('${p}')">👁 View</button></li>`;
      }).join("")
    }</ul>`;
    document.getElementById("topTaxPlayers").style.display = "block";
  } catch (e) {
    console.error("❌ Failed to load admin data:", e);
    alert("❌ Admin panel failed to load.");
  }
}

function calculateTotalTaxFromLog(logText) {
  totalTaxByPlayer = {};
  const lines = logText.split(/\r?\n/);
  lines.forEach(line => {
    const match = line.match(/\] - ([a-zA-Z0-9_.]+) (bought|sold).*?\$([\d,\.]+)/);
    if (!match) return;
    const [_, player, type, amountStr] = match;
    const amount = parseFloat(amountStr.replace(/,/g, ""));
    const tax = type === "bought" ? +(amount * 0.04).toFixed(2) : +(amount * 0.10).toFixed(2);
    if (!totalTaxByPlayer[player]) totalTaxByPlayer[player] = 0;
    totalTaxByPlayer[player] += tax;
  });
}

function viewPlayerAsAdmin(player) {
  const paid = (paymentHistory[player] || []).reduce((s, e) => s + Number(e.amount), 0);
  const total = totalTaxByPlayer[player] || 0;
  const due = Math.max(0, total - paid);

  const win = window.open("", "_blank");
  win.document.write(`
    <html><head><title>${player}</title>
    <style>body{background:#111;color:#eee;font-family:sans-serif;padding:20px}
    input,button{padding:6px;margin:6px}</style></head><body>
    <h2>👤 ${player}</h2>
    <p>Total Tax: $${total.toFixed(2)}</p>
    <p>Paid: $${paid.toFixed(2)}</p>
    <p>Due: $${due.toFixed(2)}</p>
    <input id="amt" type="number" placeholder="Amount" />
    <input id="desc" placeholder="Reason" />
    <button onclick="pay()">💸 Govt Pay</button>
    <script>
      function pay() {
        const amt = parseFloat(document.getElementById('amt').value);
        const desc = document.getElementById('desc').value;
        if (!amt || amt <= 0 || !desc) return alert('❌ Fill valid amount and reason');
        fetch("${webhookURL}", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            content: "🏛️ **Govt Payment**\\nPlayer: \`${player}\`\\nAmount: $" + amt + "\\nReason: " + desc
          })
        }).then(() => alert("✅ Payment sent")).catch(() => alert("❌ Failed"));
      }
    </script></body></html>
  `);
}

function syncTax() {
  fetch(syncTaxURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ paidPlayers, paymentHistory, taxDeadline })
  }).then(r => alert(r.ok ? "✅ Synced Tax" : "❌ Failed"));
}

function syncBank() {
  fetch(syncBankURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ accounts: bankAccounts })
  }).then(r => alert(r.ok ? "✅ Synced Bank" : "❌ Failed"));
}
</script>

</body>
</html>
