<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🛠️ Admin Panel</title>
  <style>
    body { font-family: Arial; background: #111; color: #eee; padding: 20px; }
    h2 { color: gold; }
    input, textarea, button {
      margin: 6px; padding: 6px; border-radius: 4px; border: none;
      font-family: inherit; font-size: 14px;
    }
    input, textarea {
      background: #222; color: #fff; width: 250px;
    }
    button {
      background: gold; color: #000; cursor: pointer;
    }
    button:hover { background: orange; }
    .player {
      margin: 14px 0;
      padding: 12px;
      background: #1c1c1c;
      border: 1px solid #444;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h2>🔐 Admin Login</h2>
  <input id="adminId" placeholder="Admin Bank ID" />
  <input id="adminPass" type="password" placeholder="Admin Password" />
  <button onclick="adminLogin()">Login</button>

  <div id="adminPanel" style="display:none;">
    <h2>📋 All Player Accounts</h2>
    <div id="playerList">Loading...</div>
  </div>

  <script>
    const taxURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
    const bankURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/bank-data.json";
    const syncTaxURL = "https://syncs.1987sakshamsingh.workers.dev/";
    const payWebhook = "https://tax-hook.1987sakshamsingh.workers.dev/?type=pay";

    let paidPlayers = {}, paymentHistory = {}, taxDeadline = {}, bankAccounts = {};

    async function adminLogin() {
      const id = document.getElementById("adminId").value.trim();
      const pass = document.getElementById("adminPass").value.trim();

      try {
        const res = await fetch("https://raw.githubusercontent.com/Minecraft2613/taxess/main/admin.json");
        const admin = await res.json();

        if (!admin || !Array.isArray(admin.allowedDiscords)) {
          return alert("❌ Invalid admin.json format");
        }

        const discord = prompt("Enter your Discord username (e.g. Ansh_2613)");
        if (!admin.allowedDiscords.includes(discord)) {
          return alert("❌ Discord not allowed.");
        }

        if (id === admin.id && pass === admin.pass) {
          alert("✅ Admin Access Granted!");
          loadAllData();
        } else {
          alert("❌ Incorrect ID or Password.");
        }

      } catch (err) {
        console.error("❌ Admin Login Failed", err);
        alert("❌ Could not fetch admin.json");
      }
    }

    async function loadAllData() {
      try {
        const [taxRes, bankRes] = await Promise.all([
          fetch(taxURL), fetch(bankURL)
        ]);
        const taxData = await taxRes.json();
        const bankData = await bankRes.json();
        paidPlayers = taxData.paidPlayers || {};
        paymentHistory = taxData.paymentHistory || {};
        taxDeadline = taxData.taxDeadline || {};
        bankAccounts = bankData.accounts || {};

        document.getElementById("adminPanel").style.display = "block";
        displayPlayers();
      } catch (e) {
        console.error("❌ Failed to load tax or bank data", e);
        alert("❌ Could not load data");
      }
    }

    function displayPlayers() {
      const list = document.getElementById("playerList");
      list.innerHTML = "";

      Object.keys(bankAccounts).forEach(player => {
        const acc = bankAccounts[player];
        const payments = paymentHistory[player] || [];
        const paid = payments.reduce((sum, e) => sum + e.amount, 0);
        const due = Math.max(0, (paidPlayers[player] || 0) - paid);

        const box = document.createElement("div");
        box.className = "player";
        box.innerHTML = `
          <b>👤 ${player}</b><br>
          🏦 Bank Created: ✅<br>
          🆔 Bank ID: ${acc.id}<br>
          🔒 Password: ${acc.password}<br>
          📛 Username: ${acc.username}<br>
          📞 Contact: ${acc.contact || "N/A"}<br>
          💰 Paid: $${paid.toFixed(2)}<br>
          ❗ Due: $${due.toFixed(2)}<br>
          <input type="number" id="amt-${player}" placeholder="Govt Pay Amount" />
          <textarea id="desc-${player}" placeholder="Reason (required)"></textarea><br>
          <button onclick="payAsGovt('${player}', ${due})">💸 Govt Pay</button>
        `;
        list.appendChild(box);
      });
    }

    function payAsGovt(player, maxDue) {
      const amt = parseFloat(document.getElementById(`amt-${player}`).value);
      const desc = document.getElementById(`desc-${player}`).value.trim();

      if (!amt || amt <= 0 || amt > maxDue) return alert("❌ Invalid amount");
      if (!desc) return alert("❌ Reason required");

      const entry = {
        amount: amt,
        date: new Date().toLocaleString(),
        adminNote: `Govt Paid: ${desc}`
      };

      if (!paymentHistory[player]) paymentHistory[player] = [];
      paymentHistory[player].unshift(entry);
      paidPlayers[player] = paymentHistory[player].reduce((s, e) => s + e.amount, 0);

      // Secure webhook to Cloudflare
      fetch(payWebhook, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          content: `🏛️ **Govt Payment**\nPlayer: \`${player}\`\nAmount: $${amt}\nReason: ${desc}`
        })
      });

      // Sync tax data to GitHub via Cloudflare
      fetch(syncTaxURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paidPlayers, paymentHistory, taxDeadline })
      }).then(() => {
        alert("✅ Payment saved & synced");
        displayPlayers();
      }).catch(() => {
        alert("⚠️ Failed to sync");
      });
    }
  </script>
</body>
</html>
