<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>🛠️ Admin Panel</title>
  <style>
    body { background: #111; color: #eee; font-family: Arial; padding: 20px; }
    input, button, textarea {
      background: #222; color: #fff; border: none; border-radius: 4px; padding: 8px;
      margin: 5px 0; font-family: inherit;
    }
    button { background: gold; color: #111; cursor: pointer; }
    button:hover { background: orange; }
    .section { margin-top: 20px; }
    .player-box {
      background: #1c1c1c; padding: 15px; border: 1px solid #444; margin: 10px 0;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h2>🔐 Admin Login</h2>
  <input id="adminId" placeholder="Bank ID (e.g. BANK123456)" />
  <input id="adminPass" type="password" placeholder="Password" />
  <button onclick="adminLogin()">Login</button>

  <div id="adminPanel" style="display:none;">
    <h2>🛠️ Admin Control Panel</h2>
    <button onclick="renderPlayerTax()">📊 View Player Taxes</button>
    <button onclick="renderBankData()">🏦 View Bank Info</button>
    <button onclick="sync('tax')">💾 Sync Tax</button>
    <button onclick="sync('bank')">💾 Sync Bank</button>
    <button onclick="location.reload()">🚪 Exit</button>

    <div class="section" id="playerTax"></div>
    <div class="section" id="bankData"></div>
  </div>

<script>
const taxURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
const bankURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/bank-data.json";
const syncTaxURL = "https://syncs.1987sakshamsingh.workers.dev/";
const syncBankURL = "https://b-syncs.1987sakshamsingh.workers.dev/";
const webhookURL = "https://tax-hook.1987sakshamsingh.workers.dev/?type=pay";

let paidPlayers = {}, paymentHistory = {}, taxDeadline = {}, bankAccounts = {}, totalTaxByPlayer = {};

async function adminLogin() {
  const id = document.getElementById("adminId").value.trim();
  const pass = document.getElementById("adminPass").value.trim();
  try {
    const res = await fetch("https://raw.githubusercontent.com/Minecraft2613/taxess/main/admin.json");
    const admin = await res.json();
    if (id === admin.id && pass === admin.pass) {
      document.getElementById("adminPanel").style.display = "block";
      await loadAllData();
      alert("✅ Admin Login Successful");
    } else {
      alert("❌ Invalid credentials");
    }
  } catch (e) {
    alert("❌ Failed to load admin.json");
  }
}

async function loadAllData() {
  const [taxRes, bankRes, transRes] = await Promise.all([
    fetch(taxURL), fetch(bankURL),
    fetch("https://raw.githubusercontent.com/Minecraft2613/taxess/main/transaction-log.txt")
  ]);
  const tax = await taxRes.json();
  const bank = await bankRes.json();
  const log = await transRes.text();
  paidPlayers = tax.paidPlayers || {};
  paymentHistory = tax.paymentHistory || {};
  taxDeadline = tax.taxDeadline || {};
  bankAccounts = bank.accounts || {};
  calculateTotalTaxFromLog(log);
}

function calculateTotalTaxFromLog(log) {
  totalTaxByPlayer = {};
  const lines = log.split(/\r?\n/);
  lines.forEach(line => {
    const match = line.match(/\] - ([a-zA-Z0-9_.]+) (bought|sold).*?\$([\d,\.]+)/);
    if (!match) return;
    const [_, player, action, amtStr] = match;
    const amount = parseFloat(amtStr.replace(/,/g, ""));
    const tax = action === "bought" ? +(amount * 0.04).toFixed(2) : +(amount * 0.10).toFixed(2);
    totalTaxByPlayer[player] = (totalTaxByPlayer[player] || 0) + tax;
  });
}

function renderPlayerTax() {
  const container = document.getElementById("playerTax");
  container.innerHTML = `<h3>📊 Player Taxes</h3>`;
  for (const player in totalTaxByPlayer) {
    const paid = (paymentHistory[player] || []).reduce((s, e) => s + Number(e.amount), 0);
    const total = totalTaxByPlayer[player] || 0;
    const due = Math.max(0, total - paid);
    const isBedrock = player.startsWith(".") ? "Bedrock" : "Java";
    container.innerHTML += `
      <div class="player-box">
        <b>👤 ${player}</b> [${isBedrock}]<br>
        💰 Total: $${total.toFixed(2)} | Paid: $${paid.toFixed(2)} | Due: $${due.toFixed(2)}<br>
        <button onclick="viewPlayer('${player}')">👁 View</button>
      </div>`;
  }
}

function renderBankData() {
  const container = document.getElementById("bankData");
  container.innerHTML = `<h3>🏦 Bank Information</h3>`;
  const allPlayers = new Set([
    ...Object.keys(bankAccounts),
    ...Object.keys(totalTaxByPlayer)
  ]);
  for (const player of allPlayers) {
    const acc = bankAccounts[player];
    if (acc) {
      container.innerHTML += `
        <div class="player-box">
          <b>👤 ${player}</b><br>
          🆔 ID: ${acc.id}<br>
          🔑 Password: ${acc.password}<br>
          🧾 Username: ${acc.username}<br>
          📞 Contact: ${acc.contact || "N/A"}
        </div>`;
    } else {
      container.innerHTML += `
        <div class="player-box">
          <b>👤 ${player}</b><br>
          ❌ Bank Not Created<br>
          🆔 ID: N/A<br>
          🔑 Password: N/A<br>
          🧾 Username: N/A<br>
          📞 Contact: N/A
        </div>`;
    }
  }
}

function sync(type) {
  const url = type === "tax" ? syncTaxURL : syncBankURL;
  const body = type === "tax"
    ? { paidPlayers, paymentHistory, taxDeadline }
    : { accounts: bankAccounts };
  fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  }).then(res => res.ok
    ? alert(`✅ Synced ${type}`)
    : res.text().then(text => alert("❌ Sync failed:\n" + text)));
}

function viewPlayer(player) {
  const newWin = window.open("", "_blank");
  const paid = (paymentHistory[player] || []).reduce((s, e) => s + Number(e.amount), 0);
  const total = totalTaxByPlayer[player] || 0;
  const due = Math.max(0, total - paid);
  newWin.document.write(`
    <html><head><title>${player}</title>
    <style>
      body { background: #111; color: #eee; font-family: sans-serif; padding: 20px; }
      input, button, textarea { background: #222; color: #fff; border: none; padding: 8px; margin: 5px; border-radius: 4px; }
      button { background: gold; color: #000; cursor: pointer; }
      button:hover { background: orange; }
    </style></head><body>
    <h2>👤 ${player}</h2>
    <p>💰 Total Tax: $${total.toFixed(2)}</p>
    <p>✅ Paid: $${paid.toFixed(2)}</p>
    <p>❗ Due: $${due.toFixed(2)}</p>
    <textarea id="desc" placeholder="Reason (optional)"></textarea><br>
    <input id="amt" type="number" placeholder="Amount to pay" />
    <button onclick="pay()">💸 Govt Pay</button>
    <button onclick="reset()">🗑 Reset Deadline & History</button>
    <script>
      function pay() {
        const amt = parseFloat(document.getElementById('amt').value);
        const desc = document.getElementById('desc').value || 'No reason given';
        if (!amt || amt <= 0) return alert('Enter valid amount');
        fetch("${webhookURL}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            content: "🏛️ **Govt Payment**\\nPlayer: \`${player}\`\\nAmount: $" + amt + "\\nReason: " + desc
          })
        }).then(() => alert("✅ Payment Sent"));
      }
      function reset() {
        fetch("${syncTaxURL}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            paidPlayers: { "${player}": 0 },
            paymentHistory: { "${player}": [] },
            taxDeadline: {}
          })
        }).then(() => alert("✅ Player Reset Complete"));
      }
    </script>
  </body></html>
  `);
}
</script>
</body>
</html>
