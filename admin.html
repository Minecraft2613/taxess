<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🛠️ Admin Panel</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; padding: 20px; }
    h2, h3 { color: gold; }
    input, button {
      margin: 6px; padding: 8px; border-radius: 4px;
      border: none; font-size: 14px;
    }
    button { background: gold; color: #000; cursor: pointer; }
    button:hover { background: orange; }
    .hidden { display: none; }
    .player { background: #1c1c1c; padding: 10px; margin: 10px 0; border-radius: 6px; border: 1px solid #444; }
  </style>
</head>
<body>

<div id="loginBox">
  <h2>🔐 Admin Login</h2>
  <input id="adminId" placeholder="Admin Bank ID" />
  <input id="adminPass" type="password" placeholder="Admin Password" />
  <button onclick="adminLogin()">Login</button>
</div>

<div id="adminPanel" class="hidden">
  <h2>🛠️ Admin Panel</h2>
  <button onclick="renderTaxView()">📊 Player Taxes</button>
  <button onclick="renderBankView()">🏦 Bank Accounts</button>
  <button onclick="syncTax()">💾 Sync Tax</button>
  <button onclick="syncBank()">💾 Sync Bank</button>
  <button onclick="exitApp()">🚪 Exit</button>
</div>

<div id="taxList" class="hidden">
  <h3>📋 Player Tax Summary</h3>
  <div id="taxPlayers"></div>
</div>

<div id="bankList" class="hidden">
  <h3>🏦 Bank Accounts</h3>
  <div id="bankPlayers"></div>
</div>

<script>
const taxURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
const bankURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/bank-data.json";
const logURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/transaction-log.txt";
const adminURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/admin.json";
const syncTaxURL = "https://syncs.1987sakshamsingh.workers.dev/";
const syncBankURL = "https://b-syncs.1987sakshamsingh.workers.dev/";
const webhookURL = "https://tax-hook.1987sakshamsingh.workers.dev/?type=pay";

let paidPlayers = {}, paymentHistory = {}, bankAccounts = {}, taxDeadline = {}, totalTaxByPlayer = {};

async function adminLogin() {
  const id = document.getElementById("adminId").value.trim();
  const pass = document.getElementById("adminPass").value.trim();
  try {
    const res = await fetch(adminURL);
    const admin = await res.json();
    if (id === admin.id && pass === admin.pass) {
      alert("✅ Admin Login Successful");
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("adminPanel").classList.remove("hidden");
      await loadData();
    } else {
      alert("❌ Invalid credentials");
    }
  } catch {
    alert("❌ Could not verify admin.");
  }
}

async function loadData() {
  const [taxRes, bankRes, logRes] = await Promise.all([
    fetch(taxURL), fetch(bankURL), fetch(logURL)
  ]);
  const taxData = await taxRes.json();
  const bankData = await bankRes.json();
  const logText = await logRes.text();

  paidPlayers = taxData.paidPlayers || {};
  paymentHistory = taxData.paymentHistory || {};
  bankAccounts = bankData.accounts || {};
  taxDeadline = taxData.taxDeadline || {};
  calculateTaxFromLog(logText);
}

function calculateTaxFromLog(log) {
  totalTaxByPlayer = {};
  log.split(/\r?\n/).forEach(line => {
    const match = line.match(/\] - ([\w.]+) (bought|sold).*?\$([\d,\.]+)/);
    if (!match) return;
    const [, player, action, amountStr] = match;
    const amt = parseFloat(amountStr.replace(/,/g, ""));
    const tax = +(amt * (action === "bought" ? 0.04 : 0.10)).toFixed(2);
    totalTaxByPlayer[player] = (totalTaxByPlayer[player] || 0) + tax;
  });
}

function renderTaxView() {
  document.getElementById("taxList").classList.remove("hidden");
  document.getElementById("bankList").classList.add("hidden");
  const container = document.getElementById("taxPlayers");
  container.innerHTML = "";

  const players = [...new Set([
    ...Object.keys(paidPlayers),
    ...Object.keys(paymentHistory),
    ...Object.keys(totalTaxByPlayer)
  ])];

  players.forEach(p => {
    const total = totalTaxByPlayer[p] || 0;
    const paid = (paymentHistory[p] || []).reduce((s, e) => s + Number(e.amount), 0);
    const due = Math.max(0, total - paid);
    const platform = p.startsWith(".") ? "Bedrock" : "Java";
    const cleanName = p.replace(/^\./, "");

    const div = document.createElement("div");
    div.className = "player";
    div.innerHTML = `
      👤 <b>${cleanName}</b> (${platform})<br>
      ✅ Paid: $${paid.toFixed(2)}<br>
      ❗ Due: $${due.toFixed(2)}<br>
      <button onclick="viewPlayer('${p}')">👁 View</button>
    `;
    container.appendChild(div);
  });
}

function renderBankView() {
  document.getElementById("bankList").classList.remove("hidden");
  document.getElementById("taxList").classList.add("hidden");
  const container = document.getElementById("bankPlayers");
  container.innerHTML = "";

  const allPlayers = new Set([
    ...Object.keys(bankAccounts),
    ...Object.keys(totalTaxByPlayer)
  ]);

  allPlayers.forEach(p => {
    const acc = bankAccounts[p];
    const div = document.createElement("div");
    div.className = "player";

    if (acc) {
      div.innerHTML = `
        👤 <b>${p.replace(/^\./, "")}</b><br>
        🏦 Username: ${acc.username}<br>
        🆔 ID: ${acc.id}<br>
        🔑 Pass: ${acc.password}<br>
        📞 Contact: ${acc.contact || "N/A"}
      `;
    } else {
      div.innerHTML = `
        👤 <b>${p.replace(/^\./, "")}</b><br>
        ⚠️ Bank Account: <b>Not Created</b><br>
        🏦 Username: N/A<br>
        🆔 ID: N/A<br>
        🔑 Pass: N/A<br>
        📞 Contact: N/A
      `;
    }

    container.appendChild(div);
  });
}

function syncTax() {
  fetch(syncTaxURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ paidPlayers, paymentHistory, taxDeadline })
  }).then(res => alert(res.ok ? "✅ Synced Tax" : "❌ Failed"));
}

function syncBank() {
  fetch(syncBankURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ accounts: bankAccounts })
  }).then(res => alert(res.ok ? "✅ Synced Bank" : "❌ Failed"));
}

function viewPlayer(p) {
  const win = window.open("", "_blank");
  win.document.write(`
    <html><head><title>Admin View - ${p}</title><style>
    body { background: #111; color: #eee; font-family: sans-serif; padding: 20px; }
    input, button { padding: 6px; margin: 6px; }
    </style></head><body>
    <h2>👁 Admin Payment Panel for ${p}</h2>
    <p>Total Tax: $${(totalTaxByPlayer[p] || 0).toFixed(2)}</p>
    <p>Paid: $${(paymentHistory[p] || []).reduce((s,e)=>s+Number(e.amount), 0).toFixed(2)}</p>
    <p>Due: $${Math.max(0, (totalTaxByPlayer[p] || 0) - (paymentHistory[p] || []).reduce((s,e)=>s+Number(e.amount), 0)).toFixed(2)}</p>
    <input type="number" id="amt" placeholder="Amount" />
    <input type="text" id="desc" placeholder="Reason (optional)" />
    <button onclick="pay()">Pay as Govt</button>
    <script>
      function pay() {
        const amt = parseFloat(document.getElementById('amt').value);
        const desc = document.getElementById('desc').value || "Paid by Govt";
        if (!amt || amt <= 0) return alert("❌ Invalid amount");
        fetch('${webhookURL}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: '🏛️ Govt Paid for ${p}\\nAmount: $' + amt + '\\nReason: ' + desc })
        }).then(() => alert("✅ Paid")).catch(() => alert("❌ Failed"));
      }
    </script>
    </body></html>
  `);
}

function exitApp() {
  location.reload();
}
</script>
</body>
</html>
