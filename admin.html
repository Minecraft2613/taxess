<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🛠️ Admin Panel</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: radial-gradient(ellipse at top, #111 0%, #000 100%);
      color: #f8f8f8;
      padding: 20px;
      animation: glowPulse 4s ease-in-out infinite;
    }
    @keyframes glowPulse {
      0%, 100% { background-color: #111; }
      50% { background-color: #181818; }
    }
    h2, h3 { color: #ffaa00; text-shadow: 0 0 10px #ffaa00; }
    button {
      background: #ffaa00; color: #000;
      padding: 6px 12px; margin: 4px;
      border: none; border-radius: 4px; cursor: pointer;
      box-shadow: 0 0 8px #ffaa00;
    }
    button:hover { background: #ffcc00; }
    .playerBox {
      background: #1a1a1a;
      border-left: 5px solid #ffaa00;
      margin: 10px 0; padding: 10px;
      box-shadow: 0 0 8px #ffaa00 inset;
    }
    input, textarea {
      background: #222;
      color: #fff;
      border: 1px solid #444;
      padding: 6px;
      margin: 4px 0;
      width: 250px;
    }
    textarea {
      width: 90%; resize: vertical;
      height: 50px;
    }
    details {
      margin-bottom: 10px;
    }
    summary {
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
      color: #ffd700;
    }
    #searchBar {
      margin: 10px 0;
      padding: 8px;
      background: #111;
      border: 1px solid #ffaa00;
      color: #fff;
      width: 250px;
    }
  </style>
</head>
<body>
  <h2>🛠️ Admin Panel</h2>
  <div id="adminPanel">
    <button onclick="syncTax()">💾 Sync Tax</button>
    <button onclick="syncBank()">💾 Sync Bank</button>
    <button onclick="location.reload()">🔄 Refresh</button>
  </div>

  <input type="text" id="searchBar" placeholder="🔍 Search player..." oninput="filterPlayers()"/>

  <h3>📋 All Players</h3>
  <div id="playerList">Loading...</div>

  <script>
    const taxURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
    const bankURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/bank-data.json";
    const syncTaxURL = "https://syncs.1987sakshamsingh.workers.dev/";
    const syncBankURL = "https://b-syncs.1987sakshamsingh.workers.dev/";
    const webhookURL = "https://tax-hook.1987sakshamsingh.workers.dev/?type=pay";

    let paidPlayers = {}, paymentHistory = {}, taxDeadline = {}, bankAccounts = {}, totalTaxByPlayer = {}, allPlayers = [];

    window.onload = async () => {
      const [taxRes, bankRes, transRes] = await Promise.all([
        fetch(taxURL), fetch(bankURL),
        fetch("https://raw.githubusercontent.com/Minecraft2613/taxess/main/transaction-log.txt")
      ]);
      const taxData = await taxRes.json();
      const bankData = await bankRes.json();
      const logText = await transRes.text();

      paidPlayers = taxData.paidPlayers || {};
      paymentHistory = taxData.paymentHistory || {};
      taxDeadline = taxData.taxDeadline || {};
      bankAccounts = bankData.accounts || {};

      calculateTax(logText);

      allPlayers = [...new Set([
        ...Object.keys(paidPlayers),
        ...Object.keys(paymentHistory),
        ...Object.keys(bankAccounts),
        ...logText.match(/\] - ([a-zA-Z0-9_.]+)/g)?.map(m => m.split(" - ")[1].split(" ")[0]) || []
      ])].sort();

      renderPlayers();
    };

    function calculateTax(log) {
      totalTaxByPlayer = {};
      log.split(/\r?\n/).forEach(line => {
        const m = line.match(/\] - ([a-zA-Z0-9_.]+) (bought|sold).*?\$([\d,\.]+)/);
        if (!m) return;
        const [_, name, action, amount] = m;
        const tax = +(parseFloat(amount.replace(/,/g, "")) * (action === "bought" ? 0.04 : 0.10)).toFixed(2);
        if (!totalTaxByPlayer[name]) totalTaxByPlayer[name] = 0;
        totalTaxByPlayer[name] += tax;
      });
    }

    function renderPlayers() {
      const list = document.getElementById("playerList");
      list.innerHTML = allPlayers.map(player => {
        const paid = (paymentHistory[player] || []).reduce((s, e) => s + +e.amount, 0);
        const total = totalTaxByPlayer[player] || 0;
        const due = Math.max(0, total - paid);
        const version = player.startsWith(".") ? "Bedrock" : "Java";
        const bank = bankAccounts[player] || null;

        return `
        <details class="playerBox" data-name="${player.toLowerCase()}">
          <summary>👤 ${player} (${version}) - 💰 $${due.toFixed(2)}</summary>
          <div style="padding-left:10px;">
            🏦 Bank: ${bank ? `
              ID: ${bank.id}<br>
              Pass: ${bank.password}` : "❌ Not Created (N/A)"}<br><br>

            <input type="number" id="pay-${player}" placeholder="Govt Pay $" />
            <textarea id="reason-${player}" placeholder="Reason for payment (optional)"></textarea><br>
            <button onclick="payAsGovt('${player}')">💸 Pay</button>
            <button onclick="resetPlayer('${player}')">🗑 Reset</button>
          </div>
        </details>`;
      }).join("");
    }

    function filterPlayers() {
      const query = document.getElementById("searchBar").value.toLowerCase();
      document.querySelectorAll("#playerList details").forEach(el => {
        el.style.display = el.getAttribute("data-name").includes(query) ? "block" : "none";
      });
    }

    function payAsGovt(player) {
      const amt = parseFloat(document.getElementById(`pay-${player}`).value);
      const reason = document.getElementById(`reason-${player}`).value.trim() || "N/A";
      if (!amt || amt <= 0) return alert("❌ Enter valid amount");

      const entry = { amount: amt, date: new Date().toLocaleString(), adminNote: `Paid by Govt: ${reason}` };
      if (!paymentHistory[player]) paymentHistory[player] = [];
      paymentHistory[player].unshift(entry);
      paidPlayers[player] = paymentHistory[player].reduce((s, e) => s + +e.amount, 0);

      fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          content: `🏛 **Govt Paid**\nPlayer: \`${player}\`\nAmount: $${amt}\nReason: ${reason}`
        })
      }).then(() => alert("✅ Payment Sent"));

      fetch(syncTaxURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paidPlayers, paymentHistory, taxDeadline })
      });
    }

    function resetPlayer(player) {
      if (!confirm(`Reset all tax data for ${player}?`)) return;
      paidPlayers[player] = 0;
      paymentHistory[player] = [];
      delete taxDeadline[player];
      fetch(syncTaxURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paidPlayers, paymentHistory, taxDeadline })
      }).then(() => alert("✅ Player Reset Complete"));
    }

    function syncTax() {
      fetch(syncTaxURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paidPlayers, paymentHistory, taxDeadline })
      }).then(() => alert("✅ Tax Synced"));
    }

    function syncBank() {
      fetch(syncBankURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ accounts: bankAccounts })
      }).then(() => alert("✅ Bank Synced"));
    }
  </script>
</body>
</html>
