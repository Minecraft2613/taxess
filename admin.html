<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🛠️ Admin Panel</title>
  <style>
    body { background: #111; color: #eee; font-family: Arial; padding: 20px; }
    h2, h3 { color: gold; }
    button, input {
      padding: 6px 10px; margin: 5px; border: none; border-radius: 4px;
      background: gold; color: #000; cursor: pointer;
    }
    input { background: #222; color: #fff; width: 250px; }
    button:hover { background: orange; }
    .hidden { display: none; }
    .section, .box {
      margin: 12px 0; padding: 12px; border-radius: 6px;
      background: #1c1c1c; border: 1px solid #333;
    }
  </style>
</head>
<body>
  <div id="loginBox">
    <h2>🔐 Admin Login</h2>
    <input id="adminId" placeholder="Admin Bank ID" /><br>
    <input id="adminPass" type="password" placeholder="Admin Password" /><br>
    <button onclick="adminLogin()">Login</button>
  </div>

  <div id="adminPanel" class="hidden">
    <h2>🛠️ Admin Dashboard</h2>
    <button onclick="showSection('taxSection')">📊 Player Taxes</button>
    <button onclick="showSection('bankSection')">🏦 Bank Accounts</button>
    <button onclick="syncTax()">💾 Sync Tax</button>
    <button onclick="syncBank()">💾 Sync Bank</button>
    <button onclick="location.reload()">🚪 Exit</button>
  </div>

  <div id="taxSection" class="hidden">
    <h3>📊 Player Taxes</h3>
    <div id="taxList">Loading...</div>
  </div>

  <div id="bankSection" class="hidden">
    <h3>🏦 Bank Accounts</h3>
    <div id="bankList">Loading...</div>
  </div>

<script>
const taxURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
const bankURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/bank-data.json";
const logURL  = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/transaction-log.txt";
const syncTaxURL = "https://syncs.1987sakshamsingh.workers.dev/";
const syncBankURL = "https://b-syncs.1987sakshamsingh.workers.dev/";
const webhookURL = "https://tax-hook.1987sakshamsingh.workers.dev/?type=pay";

let paidPlayers = {}, paymentHistory = {}, bankAccounts = {}, taxDeadline = {};
let calculatedTax = {};

async function adminLogin() {
  const id = document.getElementById("adminId").value.trim();
  const pass = document.getElementById("adminPass").value.trim();
  try {
    const res = await fetch("https://raw.githubusercontent.com/Minecraft2613/taxess/main/admin.json");
    const admin = await res.json();
    if (id === admin.id && pass === admin.pass) {
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("adminPanel").classList.remove("hidden");
      await loadData();
    } else {
      alert("❌ Invalid credentials");
    }
  } catch (e) {
    alert("❌ Admin load failed");
    console.error(e);
  }
}

async function loadData() {
  const [taxRes, bankRes, logRes] = await Promise.all([
    fetch(taxURL), fetch(bankURL), fetch(logURL)
  ]);
  const tax = await taxRes.json();
  const bank = await bankRes.json();
  const log = await logRes.text();

  paidPlayers = tax.paidPlayers || {};
  paymentHistory = tax.paymentHistory || {};
  taxDeadline = tax.taxDeadline || {};
  bankAccounts = bank.accounts || {};

  parseTransactions(log);
  renderTaxList();
  renderBankList();
}

function parseTransactions(log) {
  calculatedTax = {};
  log.split("\n").forEach(line => {
    const match = line.match(/\[(.*?)\] - (.*?) (bought|sold).*?\$([\d,.]+)/);
    if (!match) return;
    const player = match[2];
    const action = match[3];
    const amount = parseFloat(match[4].replace(/,/g, ""));
    const tax = action === "bought" ? amount * 0.04 : amount * 0.10;
    if (!calculatedTax[player]) calculatedTax[player] = 0;
    calculatedTax[player] += tax;
  });
}

function showSection(sectionId) {
  document.getElementById("taxSection").classList.add("hidden");
  document.getElementById("bankSection").classList.add("hidden");
  document.getElementById(sectionId).classList.remove("hidden");
}

function renderTaxList() {
  const container = document.getElementById("taxList");
  container.innerHTML = "";

  Object.keys(calculatedTax).forEach(player => {
    const total = calculatedTax[player] || 0;
    const paid = (paymentHistory[player] || []).reduce((sum, e) => sum + e.amount, 0);
    const due = Math.max(0, total - paid);

    const div = document.createElement("div");
    div.className = "box";
    div.innerHTML = `
      👤 <b>${player}</b><br>
      💰 Total: $${total.toFixed(2)} | ✅ Paid: $${paid.toFixed(2)} | ❗ Due: $${due.toFixed(2)}<br>
      <button onclick="viewTax('${player}', ${total}, ${paid})">👁 View</button>
    `;
    container.appendChild(div);
  });
}

function renderBankList() {
  const container = document.getElementById("bankList");
  container.innerHTML = "";

  const allPlayers = new Set([...Object.keys(calculatedTax), ...Object.keys(bankAccounts)]);
  allPlayers.forEach(player => {
    const acc = bankAccounts[player];
    const div = document.createElement("div");
    div.className = "box";
    if (acc) {
      div.innerHTML = `
        👤 <b>${player}</b><br>
        ✅ Bank Created<br>
        🏦 Username: ${acc.username}<br>
        🆔 ID: ${acc.id}<br>
        🔐 Pass: ${acc.password}<br>
        📞 Contact: ${acc.contact || "N/A"}
      `;
    } else {
      div.innerHTML = `
        👤 <b>${player}</b><br>
        ❌ Bank Not Created
      `;
    }
    container.appendChild(div);
  });
}

function viewTax(player, total, paid) {
  const due = Math.max(0, total - paid);
  const win = window.open("", "_blank");
  win.document.write(`
    <html><head><title>${player} Tax</title>
    <style>body { background:#111; color:#fff; font-family:Arial; padding:20px; }
    input,button { padding:6px; margin:6px; }</style></head><body>
    <h2>👤 ${player}</h2>
    <p>Total Tax: $${total.toFixed(2)}</p>
    <p>Paid: $${paid.toFixed(2)}</p>
    <p>Due: $${due.toFixed(2)}</p>
    <input id="amt" type="number" placeholder="Amount" />
    <input id="desc" placeholder="Reason" />
    <button onclick="govtPay()">Pay as Govt</button>
    <script>
      function govtPay() {
        const amt = parseFloat(document.getElementById('amt').value);
        const desc = document.getElementById('desc').value;
        if (!amt || amt <= 0 || !desc) return alert('Invalid');
        fetch('${webhookURL}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            content: '🏛️ **Govt Payment**\\nPlayer: \`${player}\`\\nAmount: $' + amt + '\\nReason: ' + desc
          })
        }).then(() => alert('✅ Payment Sent')).catch(() => alert('❌ Failed'));
      }
    </script></body></html>
  `);
}

function syncTax() {
  fetch(syncTaxURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ paidPlayers, paymentHistory, taxDeadline })
  }).then(r => alert(r.ok ? "✅ Synced Tax" : "❌ Failed"));
}

function syncBank() {
  fetch(syncBankURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ accounts: bankAccounts })
  }).then(r => alert(r.ok ? "✅ Synced Bank" : "❌ Failed"));
}
</script>
</body>
</html>
