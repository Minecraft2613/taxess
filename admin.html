<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🛠️ Admin Panel</title>
  <style>
    body {
      background: #0c0c0c;
      font-family: 'Segoe UI', sans-serif;
      color: #fff;
      margin: 20px;
    }
    h2, h3 { color: orange; }
    .section {
      background: #111;
      border: 2px solid orange;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 0 0 10px orange;
    }
    button {
      background: orange;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px 3px;
      font-weight: bold;
    }
    button:hover {
      background: #ff9900;
    }
    .player-box {
      background: #1a1a1a;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #444;
      border-left: 5px solid orange;
      border-radius: 6px;
    }
    .platform {
      font-size: 12px;
      opacity: 0.7;
    }
    input, textarea {
      padding: 6px;
      margin-top: 5px;
      width: 90%;
      border-radius: 5px;
      border: 1px solid #333;
      background: #222;
      color: #fff;
    }
  </style>
</head>
<body>
  <h2>🛠️ Admin Panel</h2>
  <div class="section">
    <button onclick="syncTax()">💾 Sync Tax</button>
    <button onclick="syncBank()">💾 Sync Bank</button>
    <button onclick="location.reload()">🚪 Exit</button>
  </div>

  <div class="section">
    <h3>📊 Player Tax Overview</h3>
    <div id="taxSection">Loading tax data...</div>
  </div>

  <div class="section">
    <h3>🏦 Bank Account Details</h3>
    <div id="bankSection">Loading bank data...</div>
  </div>

<script>
const taxURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
const bankURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/bank-data.json";
const logURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/transaction-log.txt";
const syncTaxURL = "https://syncs.1987sakshamsingh.workers.dev/";
const syncBankURL = "https://b-syncs.1987sakshamsingh.workers.dev/";
const webhookURL = "https://tax-hook.1987sakshamsingh.workers.dev/?type=pay";

let paidPlayers = {}, paymentHistory = {}, taxDeadline = {}, bankAccounts = {}, totalTaxByPlayer = {};

loadData();

async function loadData() {
  const [taxRes, bankRes, logRes] = await Promise.all([
    fetch(taxURL), fetch(bankURL), fetch(logURL)
  ]);
  const tax = await taxRes.json();
  const bank = await bankRes.json();
  const log = await logRes.text();

  paidPlayers = tax.paidPlayers || {};
  paymentHistory = tax.paymentHistory || {};
  taxDeadline = tax.taxDeadline || {};
  bankAccounts = bank.accounts || {};

  totalTaxByPlayer = {};
  log.split(/\r?\n/).forEach(line => {
    const m = line.match(/\] - ([\w.]+) (bought|sold).*?\$([\d,\.]+)/);
    if (!m) return;
    const [_, player, type, amount] = m;
    const val = parseFloat(amount.replace(/,/g, ""));
    const tax = +(type === "bought" ? val * 0.04 : val * 0.10).toFixed(2);
    totalTaxByPlayer[player] = (totalTaxByPlayer[player] || 0) + tax;
  });

  renderTaxSection();
  renderBankSection();
}

function renderTaxSection() {
  const out = document.getElementById("taxSection");
  out.innerHTML = "";

  const players = [...new Set([
    ...Object.keys(paidPlayers),
    ...Object.keys(paymentHistory),
    ...Object.keys(totalTaxByPlayer)
  ])];

  players.forEach(player => {
    const total = totalTaxByPlayer[player] || 0;
    const paid = (paymentHistory[player] || []).reduce((s, e) => s + +e.amount, 0);
    const due = Math.max(0, total - paid);
    const platform = player.startsWith(".") ? "Bedrock" : "Java";

    const div = document.createElement("div");
    div.className = "player-box";
    div.innerHTML = `
      <b>${player}</b> — Due: $${due.toFixed(2)}
      <div class="platform">Platform: ${platform}</div>
      <button onclick="view('${player}')">👁 View</button>
      <button onclick="payAsGovt('${player}')">💸 Pay as Govt</button>
      <button onclick="resetPlayer('${player}')">♻️ Reset</button>
    `;
    out.appendChild(div);
  });
}

function renderBankSection() {
  const out = document.getElementById("bankSection");
  out.innerHTML = "";

  const players = [...new Set([
    ...Object.keys(bankAccounts),
    ...Object.keys(totalTaxByPlayer)
  ])];

  players.forEach(player => {
    const acc = bankAccounts[player];
    const div = document.createElement("div");
    div.className = "player-box";
    if (acc) {
      div.innerHTML = `
        <b>${player}</b><br>
        🏦 Username: ${acc.username}<br>
        🆔 ID: ${acc.id}<br>
        🔑 Password: ${acc.password}<br>
        📞 Contact: ${acc.contact || "N/A"}
      `;
    } else {
      div.innerHTML = `<b>${player}</b> — ❌ Bank Not Created<br>All info: N/A`;
    }
    out.appendChild(div);
  });
}

function payAsGovt(player) {
  const amount = prompt(`Enter amount to pay as Govt for ${player}`);
  if (!amount || isNaN(amount) || amount <= 0) return alert("❌ Invalid amount.");
  const desc = prompt("Optional: Reason or description?") || "Paid by Govt";

  if (!paymentHistory[player]) paymentHistory[player] = [];
  paymentHistory[player].unshift({ amount, date: new Date().toLocaleString(), adminNote: desc });
  paidPlayers[player] = (paymentHistory[player].reduce((s, e) => s + +e.amount, 0));

  fetch(webhookURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ content: `🏛️ **Govt Payment**\nPlayer: \`${player}\`\nAmount: $${amount}\nReason: ${desc}` })
  }).then(() => alert("✅ Govt Payment Sent"));

  syncTax();
}

function resetPlayer(player) {
  if (!confirm(`Reset all tax data for ${player}?`)) return;
  paidPlayers[player] = 0;
  paymentHistory[player] = [];
  delete taxDeadline[player];
  syncTax();
  alert("✅ Player Reset Complete");
}

function syncTax() {
  fetch(syncTaxURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ paidPlayers, paymentHistory, taxDeadline })
  }).then(() => alert("✅ Tax Synced"));
}

function syncBank() {
  fetch(syncBankURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ accounts: bankAccounts })
  }).then(() => alert("✅ Bank Synced"));
}

function view(player) {
  alert(`🔎 View panel for ${player} opens here.\n(For now, handled in admin.html — no new window).`);
  // You can expand this to open full player panel
}
</script>
</body>
</html>
