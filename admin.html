<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel | Player Tax System</title>
  <style>
    body { font-family: Arial; background: #111; color: #eee; padding: 20px; }
    h2 { color: gold; }
    input, select, textarea, button {
      margin: 5px; padding: 6px; border: none; border-radius: 3px;
      font-family: inherit; font-size: 14px;
    }
    input, select, textarea {
      background: #222; color: #fff; width: 250px;
    }
    button {
      background: gold; color: #111; cursor: pointer;
    }
    button:hover {
      background: orange;
    }
    .player {
      margin: 12px 0;
      padding: 10px;
      border: 1px solid #444;
      background: #1c1c1c;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h2>ğŸ” Admin Login</h2>
  <input id="adminId" placeholder="Admin Bank ID" />
  <input id="adminPass" placeholder="Admin Password" type="password" />
  <button onclick="adminLogin()">Login</button>

  <div id="adminPanel" style="display:none;">
    <h2>ğŸ“‹ Player List</h2>
    <div id="playerList"></div>
  </div>

<script>
const taxURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
const bankURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/bank-data.json";
const transactionsURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/transaction-log.txt";
const syncTaxURL = "https://syncs.1987sakshamsingh.workers.dev/";
const paymentHookURL = "https://discordapp.com/api/webhooks/1387003883947032596/BkLzoSlQk6wLaPP4voI2mAshDTfXRaGkFf0mbK1Y0xfvU2XytWazF3MFjpvgugHnkKuR";

let paidPlayers = {}, paymentHistory = {}, taxDeadline = {}, bankAccounts = {}, transactionText = "";

async function adminLogin() {
  const id = document.getElementById("adminId").value.trim();
  const pass = document.getElementById("adminPass").value.trim();

  try {
    const res = await fetch("https://raw.githubusercontent.com/Minecraft2613/taxess/main/admin.json");
    const admin = await res.json();

    const ipRes = await fetch("https://api64.ipify.org?format=json");
    const { ip } = await ipRes.json();
    const discord = prompt("Enter your Discord username (e.g. Ansh_2613)");

    if (!admin.allowedDiscords.includes(discord) || !admin.allowedIps.includes(ip)) {
      return alert(`âŒ Unauthorized access.\nYour IP or Discord is not allowed.`);
    }

    if (id === admin.id && pass === admin.pass) {
      alert("âœ… Admin Logged In");
      document.querySelector("h2").style.display = "none";
      document.getElementById("adminId").style.display = "none";
      document.getElementById("adminPass").style.display = "none";
      event.target.style.display = "none";
      await loadAllData();
    } else {
      alert("âŒ Incorrect Admin Credentials");
    }
  } catch (e) {
    alert("âš ï¸ Failed to load admin data");
    console.error(e);
  }
}

async function loadAllData() {
  const [taxRes, bankRes, transRes] = await Promise.all([
    fetch(taxURL), fetch(bankURL), fetch(transactionsURL)
  ]);
  const tax = await taxRes.json();
  const bank = await bankRes.json();
  transactionText = await transRes.text();

  paidPlayers = tax.paidPlayers || {};
  paymentHistory = tax.paymentHistory || {};
  taxDeadline = tax.taxDeadline || {};
  bankAccounts = bank.accounts || {};

  document.getElementById("adminPanel").style.display = "block";
  displayPlayers();
}

function calculateRealTax(player) {
  const lines = transactionText.split(/\r?\n/);
  let buy = 0, sell = 0;

  lines.forEach(line => {
    if (!line.toLowerCase().includes(player.toLowerCase())) return;
    const buyMatch = line.match(/bought.*?\$([\d,\.]+)/);
    const sellMatch = line.match(/sold.*?\$([\d,\.]+)/);

    if (buyMatch) buy += +(parseFloat(buyMatch[1].replace(/,/g, "")) * 0.04).toFixed(2);
    if (sellMatch) sell += +(parseFloat(sellMatch[1].replace(/,/g, "")) * 0.10).toFixed(2);
  });

  return +(buy + sell).toFixed(2);
}

function displayPlayers() {
  const container = document.getElementById("playerList");
  container.innerHTML = "";

  const allPlayers = new Set([
    ...Object.keys(bankAccounts),
    ...Object.keys(paymentHistory)
  ]);

  allPlayers.forEach(player => {
    const info = bankAccounts[player];
    const paid = (paymentHistory[player] || []).reduce((s, e) => s + e.amount, 0);
    const total = calculateRealTax(player);
    const due = Math.max(0, total - paid);

    const div = document.createElement("div");
    div.className = "player";
    div.innerHTML = `
      <b>ğŸ‘¤ Player: ${player}</b><br>
      ğŸ¦ Bank Created: ${info ? "âœ…" : "âŒ"}<br>
      ${info ? `
        ğŸ“› Bank Username: ${info.username}<br>
        ğŸ†” Bank ID: ${info.id}<br>
        â˜ï¸ Contact: ${info.contact || "N/A"}<br>` : ""}
      ğŸ’° Total Tax: $${total.toFixed(2)}<br>
      âœ… Paid: $${paid.toFixed(2)}<br>
      â— Due: $${due.toFixed(2)}<br><br>
      <input id="amt-${player}" type="number" placeholder="Amount" />
      <textarea id="desc-${player}" placeholder="Reason for payment (required)"></textarea><br>
      <button onclick="payAsGovt('${player}', ${due})">ğŸ’¸ Pay as Govt</button>
    `;
    container.appendChild(div);
  });
}

function payAsGovt(player, maxDue) {
  const amt = parseFloat(document.getElementById(`amt-${player}`).value);
  const desc = document.getElementById(`desc-${player}`).value.trim();

  if (!amt || amt <= 0 || amt > maxDue) return alert("âŒ Invalid amount");
  if (!desc) return alert("âŒ Reason required");

  const entry = {
    amount: amt,
    date: new Date().toLocaleString(),
    adminNote: `Govt Paid - Reason: ${desc}`
  };

  if (!paymentHistory[player]) paymentHistory[player] = [];
  paymentHistory[player].unshift(entry);
  paidPlayers[player] = paymentHistory[player].reduce((s, e) => s + e.amount, 0);

  fetch(paymentHookURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      content: `ğŸ›ï¸ **Govt Payment**\nPlayer: \`${player}\`\nAmount: $${amt}\nReason: ${desc}`
    })
  });

  fetch(syncTaxURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ paidPlayers, paymentHistory, taxDeadline })
  }).then(() => {
    alert("âœ… Govt Payment Synced");
    displayPlayers();
  }).catch(() => alert("âš ï¸ Sync Failed"));
}
</script>
</body>
</html>
