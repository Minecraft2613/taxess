<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ› ï¸ Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; padding: 20px; }
    h2, h3 { color: #ffaa00; }
    button {
      background: #ffaa00; color: #000; padding: 6px 12px; margin: 4px;
      border: none; border-radius: 4px; cursor: pointer;
    }
    button:hover { background: #ffcc00; }
    .playerBox {
      background: #1c1c1c; margin: 10px 0; padding: 10px; border-left: 4px solid orange;
    }
    input, textarea {
      background: #222; color: #fff; border: 1px solid #555; padding: 6px;
      margin: 4px 0; width: 250px;
    }
  </style>
</head>
<body>
  <h2>ğŸ› ï¸ Admin Panel</h2>
  <div id="adminPanel">
    <button onclick="syncTax()">ğŸ’¾ Sync Tax</button>
    <button onclick="syncBank()">ğŸ’¾ Sync Bank</button>
    <button onclick="location.reload()">ğŸšª Exit</button>
  </div>

  <h3>ğŸ“‹ All Players</h3>
  <div id="playerList">Loading...</div>

  <script>
    const taxURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
    const bankURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/bank-data.json";
    const syncTaxURL = "https://syncs.1987sakshamsingh.workers.dev/";
    const syncBankURL = "https://b-syncs.1987sakshamsingh.workers.dev/";
    const webhookURL = "https://tax-hook.1987sakshamsingh.workers.dev/?type=pay";

    let paidPlayers = {}, paymentHistory = {}, taxDeadline = {}, bankAccounts = {}, totalTaxByPlayer = {};

    window.onload = async () => {
      const [taxRes, bankRes, transRes] = await Promise.all([
        fetch(taxURL), fetch(bankURL),
        fetch("https://raw.githubusercontent.com/Minecraft2613/taxess/main/transaction-log.txt")
      ]);
      const taxData = await taxRes.json();
      const bankData = await bankRes.json();
      const logText = await transRes.text();

      paidPlayers = taxData.paidPlayers || {};
      paymentHistory = taxData.paymentHistory || {};
      taxDeadline = taxData.taxDeadline || {};
      bankAccounts = bankData.accounts || {};

      calculateTax(logText);

      const players = [...new Set([
        ...Object.keys(paidPlayers),
        ...Object.keys(paymentHistory),
        ...Object.keys(bankAccounts),
        ...logText.match(/\] - ([a-zA-Z0-9_.]+)/g)?.map(m => m.split(" - ")[1].split(" ")[0]) || []
      ])];

      const list = document.getElementById("playerList");
      list.innerHTML = players.map(player => {
        const paid = (paymentHistory[player] || []).reduce((s, e) => s + +e.amount, 0);
        const total = totalTaxByPlayer[player] || 0;
        const due = Math.max(0, total - paid);
        const version = player.startsWith(".") ? "Bedrock" : "Java";
        const bank = bankAccounts[player] || null;

        return `
        <div class="playerBox">
          <strong>${player}</strong> (${version})<br>
          ğŸ’° Due: $${due.toFixed(2)}<br>
          ğŸ¦ Bank: ${bank ? `
            User: ${bank.username}<br>
            ID: ${bank.id}<br>
            Pass: ${bank.password}<br>
            Contact: ${bank.contact || "N/A"}` : "âŒ Not Created (N/A)"}<br><br>
          <input type="number" id="pay-${player}" placeholder="Govt Pay $" />
          <input type="text" id="reason-${player}" placeholder="Reason (optional)" />
          <button onclick="payAsGovt('${player}')">ğŸ’¸ Pay</button>
          <button onclick="resetPlayer('${player}')">ğŸ—‘ Reset</button>
        </div>`;
      }).join("");
    };

    function calculateTax(log) {
      totalTaxByPlayer = {};
      log.split(/\r?\n/).forEach(line => {
        const m = line.match(/\] - ([a-zA-Z0-9_.]+) (bought|sold).*?\$([\d,\.]+)/);
        if (!m) return;
        const [_, name, action, amount] = m;
        const tax = +(parseFloat(amount.replace(/,/g, "")) * (action === "bought" ? 0.04 : 0.10)).toFixed(2);
        if (!totalTaxByPlayer[name]) totalTaxByPlayer[name] = 0;
        totalTaxByPlayer[name] += tax;
      });
    }

    function payAsGovt(player) {
      const amt = parseFloat(document.getElementById(`pay-${player}`).value);
      const reason = document.getElementById(`reason-${player}`).value.trim() || "N/A";
      if (!amt || amt <= 0) return alert("âŒ Enter valid amount");

      const entry = { amount: amt, date: new Date().toLocaleString(), adminNote: `Paid by Govt: ${reason}` };
      if (!paymentHistory[player]) paymentHistory[player] = [];
      paymentHistory[player].unshift(entry);
      paidPlayers[player] = paymentHistory[player].reduce((s, e) => s + +e.amount, 0);

      fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          content: `ğŸ› **Govt Paid**\nPlayer: \`${player}\`\nAmount: $${amt}\nReason: ${reason}`
        })
      }).then(() => alert("âœ… Payment Sent"));

      fetch(syncTaxURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paidPlayers, paymentHistory, taxDeadline })
      });
    }

    function resetPlayer(player) {
      if (!confirm(`Reset all tax data for ${player}?`)) return;
      paidPlayers[player] = 0;
      paymentHistory[player] = [];
      delete taxDeadline[player];
      fetch(syncTaxURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paidPlayers, paymentHistory, taxDeadline })
      }).then(() => alert("âœ… Player Reset Complete"));
    }

    function syncTax() {
      fetch(syncTaxURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paidPlayers, paymentHistory, taxDeadline })
      }).then(() => alert("âœ… Tax Synced"));
    }

    function syncBank() {
      fetch(syncBankURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ accounts: bankAccounts })
      }).then(() => alert("âœ… Bank Synced"));
    }
  </script>
</body>
</html>
