<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel | Tax System</title>
  <style>
    body { font-family: Arial; background: #111; color: #eee; padding: 20px; }
    h2 { color: gold; }
    input, select, textarea { margin: 5px; padding: 5px; width: 250px; }
    button { margin: 5px; padding: 5px 10px; }
    .player { margin: 10px 0; padding: 10px; border: 1px solid #333; background: #1a1a1a; }
    .player b { font-size: 18px; }
  </style>
</head>
<body>
  <h2>🔐 Admin Login</h2>
  <input id="adminId" placeholder="Admin Bank ID" />
  <input id="adminPass" type="password" placeholder="Admin Password" />
  <button onclick="adminLogin()">Login</button>

  <div id="adminPanel" style="display:none;">
    <h2>📋 All Registered Players</h2>
    <div id="playerList"></div>
  </div>

<script>
const taxURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
const bankURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/bank-data.json";
const syncTaxURL = "https://syncs.1987sakshamsingh.workers.dev/";
const paymentHookURL = "https://discordapp.com/api/webhooks/1387003883947032596/BkLzoSlQk6wLaPP4voI2mAshDTfXRaGkFf0mbK1Y0xfvU2XytWazF3MFjpvgugHnkKuR";

let paidPlayers = {}, paymentHistory = {}, bankAccounts = {}, taxDeadline = {};

async function adminLogin() {
  const id = document.getElementById("adminId").value.trim();
  const pass = document.getElementById("adminPass").value.trim();

  try {
    const [adminRes, ipRes] = await Promise.all([
      fetch("https://raw.githubusercontent.com/Minecraft2613/taxess/main/admin.json"),
      fetch("https://api64.ipify.org?format=json")
    ]);
    const admin = await adminRes.json();
    const { ip } = await ipRes.json();

    const discord = prompt("Enter your Discord username (e.g. Ansh_2613)");

    if (!admin.allowedIps.includes(ip) || !admin.allowedDiscords.includes(discord)) {
      return alert(`❌ Unauthorized access.\nYour IP or Discord is not allowed.`);
    }

    if (id === admin.id && pass === admin.pass) {
      alert("✅ Admin Logged In");
      loadAllData();
    } else {
      alert("❌ Incorrect Admin Credentials");
    }
  } catch (e) {
    alert("⚠️ Failed to verify admin.");
    console.error(e);
  }
}

async function loadAllData() {
  const [taxRes, bankRes] = await Promise.all([fetch(taxURL), fetch(bankURL)]);
  const tax = await taxRes.json();
  const bank = await bankRes.json();
  paidPlayers = tax.paidPlayers || {};
  paymentHistory = tax.paymentHistory || {};
  taxDeadline = tax.taxDeadline || {};
  bankAccounts = bank.accounts || {};

  document.getElementById("adminPanel").style.display = "block";
  displayPlayers();
}

function displayPlayers() {
  const container = document.getElementById("playerList");
  container.innerHTML = "";

  Object.entries(bankAccounts).forEach(([player, data]) => {
    const paid = (paymentHistory[player] || []).reduce((s, e) => s + e.amount, 0);
    const total = estimateTax(player);
    const due = Math.max(0, total - paid);

    const div = document.createElement("div");
    div.className = "player";
    div.innerHTML = `
      <b>👤 ${player}</b><br>
      🏦 Bank ID: <code>${data.id}</code> <button onclick="copyToClipboard('${data.id}')">Copy</button><br>
      📛 Username: ${data.username}<br>
      📱 Contact: ${data.contact || "Not provided"}<br>
      💰 Total Tax: $${total.toFixed(2)}<br>
      ✅ Paid: $${paid.toFixed(2)}<br>
      ❗ Due: $${due.toFixed(2)}<br>
      <input id="amt-${player}" type="number" placeholder="Amount to pay" />
      <textarea id="desc-${player}" placeholder="Reason (required)"></textarea><br>
      <button onclick="payAsGovt('${player}', ${due})">💸 Pay as Govt</button>
    `;
    container.appendChild(div);
  });
}

function estimateTax(player) {
  // You can replace this logic with actual parsed log data
  // This is just a fallback estimation
  return 5000; // default assumed tax
}

function payAsGovt(player, maxDue) {
  const amt = parseFloat(document.getElementById(`amt-${player}`).value);
  const desc = document.getElementById(`desc-${player}`).value.trim();

  if (!amt || amt <= 0 || amt > maxDue) return alert("❌ Invalid amount");
  if (!desc) return alert("❌ Reason required");

  const entry = {
    amount: amt,
    date: new Date().toLocaleString(),
    adminNote: `Govt Paid - Reason: ${desc}`
  };

  if (!paymentHistory[player]) paymentHistory[player] = [];
  paymentHistory[player].unshift(entry);
  paidPlayers[player] = paymentHistory[player].reduce((s, e) => s + e.amount, 0);

  fetch(paymentHookURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      content: `🏛️ **Govt Payment**\nPlayer: \`${player}\`\nAmount: $${amt}\nReason: ${desc}`
    })
  });

  fetch(syncTaxURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ paidPlayers, paymentHistory, taxDeadline })
  }).then(() => {
    alert("✅ Payment successful and synced");
    displayPlayers();
  }).catch(() => {
    alert("⚠️ Sync failed");
  });
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert("📋 Copied!");
  }).catch(() => {
    alert("❌ Copy failed");
  });
}
</script>
</body>
</html>
