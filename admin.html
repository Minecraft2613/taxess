<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel | Real Tax Dashboard</title>
  <style>
    body { font-family: Arial; background: #111; color: #eee; padding: 20px; }
    h2 { color: gold; }
    input, select, textarea, button {
      margin: 5px; padding: 6px; border: none; border-radius: 3px;
      font-family: inherit; font-size: 14px;
    }
    input, select, textarea {
      background: #222; color: #fff; width: 250px;
    }
    button {
      background: gold; color: #111; cursor: pointer;
    }
    button:hover {
      background: orange;
    }
    .player {
      margin: 12px 0;
      padding: 10px;
      border: 1px solid #444;
      background: #1c1c1c;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h2>🔐 Admin Login</h2>
  <input id="adminId" placeholder="Admin Bank ID" />
  <input id="adminPass" placeholder="Admin Password" type="password" />
  <button onclick="adminLogin()">Login</button>

  <div id="adminPanel" style="display:none;">
    <h2>📋 Player List (Real Tax)</h2>
    <div id="playerList"></div>
  </div>

<script>
const taxURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
const bankURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/bank-data.json";
const logURL  = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/transaction-log.txt";
const syncTaxURL = "https://syncs.1987sakshamsingh.workers.dev/";
const paymentHookURL = "https://discordapp.com/api/webhooks/1387003883947032596/BkLzoSlQk6wLaPP4voI2mAshDTfXRaGkFf0mbK1Y0xfvU2XytWazF3MFjpvgugHnkKuR";

let paidPlayers = {}, paymentHistory = {}, taxDeadline = {}, bankAccounts = {}, taxLog = "";

async function adminLogin() {
  const id = document.getElementById("adminId").value.trim();
  const pass = document.getElementById("adminPass").value.trim();

  try {
    const res = await fetch("https://raw.githubusercontent.com/Minecraft2613/taxess/main/admin.json");
    const admin = await res.json();

    const ipRes = await fetch("https://api64.ipify.org?format=json");
    const { ip } = await ipRes.json();

    const discord = prompt("Enter your Discord username (e.g. Ansh_2613)");

    if (!admin.allowedDiscords.includes(discord) || !admin.allowedIps.includes(ip)) {
      return alert(`❌ Unauthorized access.\nYour IP or Discord is not allowed.`);
    }

    if (id === admin.id && pass === admin.pass) {
      alert("✅ Admin Logged In");
      loadAllData();
    } else {
      alert("❌ Incorrect Admin Credentials");
    }
  } catch (e) {
    alert("⚠️ Failed to load admin data");
    console.error(e);
  }
}

async function loadAllData() {
  const [taxRes, bankRes, logRes] = await Promise.all([
    fetch(taxURL), fetch(bankURL), fetch(logURL)
  ]);
  const tax = await taxRes.json();
  const bank = await bankRes.json();
  const log = await logRes.text();

  paidPlayers = tax.paidPlayers || {};
  paymentHistory = tax.paymentHistory || {};
  taxDeadline = tax.taxDeadline || {};
  bankAccounts = bank.accounts || {};
  taxLog = log;

  document.getElementById("adminPanel").style.display = "block";
  displayPlayers();
}

function calculateTaxFromLog(player) {
  const lines = taxLog.split(/\r?\n/);
  let total = 0;
  lines.forEach(line => {
    if (!line.toLowerCase().includes(player.toLowerCase())) return;

    const buy = line.match(/bought.*?\$([\d,\.]+)/);
    const sell = line.match(/sold.*?\$([\d,\.]+)/);

    if (buy) {
      const amount = parseFloat(buy[1].replace(/,/g, ""));
      total += +(amount * 0.04).toFixed(2);
    }
    if (sell) {
      const amount = parseFloat(sell[1].replace(/,/g, ""));
      total += +(amount * 0.10).toFixed(2);
    }
  });
  return +total.toFixed(2);
}

function displayPlayers() {
  const container = document.getElementById("playerList");
  container.innerHTML = "";

  const allPlayers = new Set([...Object.keys(bankAccounts), ...Object.keys(paymentHistory)]);

  allPlayers.forEach(player => {
    const info = bankAccounts[player];
    const paid = (paymentHistory[player] || []).reduce((s, e) => s + e.amount, 0);
    const total = calculateTaxFromLog(player);
    const due = Math.max(0, total - paid);

    const div = document.createElement("div");
    div.className = "player";
    div.innerHTML = `
      <b>👤 ${player}</b><br>
      🏦 Bank Created: ${info ? "✅" : "❌"}<br>
      ${info ? `
        📛 Username: ${info.username}<br>
        🆔 ID: ${info.id}<br>
        ☎️ Contact: ${info.contact || "N/A"}<br>` : ""}
      💰 Total Tax: $${total.toFixed(2)}<br>
      ✅ Paid: $${paid.toFixed(2)}<br>
      ❗ Due: $${due.toFixed(2)}<br><br>
      <input id="amt-${player}" type="number" placeholder="Amount" />
      <textarea id="desc-${player}" placeholder="Reason for payment (required)"></textarea><br>
      <button onclick="payAsGovt('${player}', ${due})">💸 Pay as Govt</button>
    `;
    container.appendChild(div);
  });
}

function payAsGovt(player, maxDue) {
  const amt = parseFloat(document.getElementById(`amt-${player}`).value);
  const desc = document.getElementById(`desc-${player}`).value.trim();

  if (!amt || amt <= 0 || amt > maxDue) return alert("❌ Invalid amount");
  if (!desc) return alert("❌ Reason required");

  const entry = {
    amount: amt,
    date: new Date().toLocaleString(),
    adminNote: `Govt Paid - Reason: ${desc}`
  };

  if (!paymentHistory[player]) paymentHistory[player] = [];
  paymentHistory[player].unshift(entry);
  paidPlayers[player] = paymentHistory[player].reduce((s, e) => s + e.amount, 0);

  fetch(paymentHookURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      content: `🏛️ **Govt Payment**
Player: \`${player}\`
Amount: $${amt}
Reason: ${desc}`
    })
  });

  fetch(syncTaxURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ paidPlayers, paymentHistory, taxDeadline })
  }).then(() => {
    alert("✅ Govt Payment Synced");
    displayPlayers();
  }).catch(() => alert("⚠️ Sync Failed"));
}
</script>
</body>
</html>
