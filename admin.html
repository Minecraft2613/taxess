<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel | Tax System</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; background: #111; color: #eee; padding: 20px; }
    h2 { color: gold; }
    input, select, textarea { margin: 5px; padding: 5px; width: 250px; }
    button { margin: 5px; padding: 5px 10px; }
    .player { margin: 10px 0; padding: 10px; border: 1px solid #333; background: #1a1a1a; }
  </style>
</head>
<body>
  <h2>üîê Admin Login</h2>
  <input id="adminId" placeholder="Admin Bank ID" />
  <input id="adminPass" placeholder="Admin Password" type="password" />
  <button onclick="adminLogin()">Login</button>

  <div id="adminPanel" style="display:none;">
    <h2>üìã All Players</h2>
    <div id="playerList"></div>
  </div>

<script>
const taxURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/tax-data.json";
const bankURL = "https://raw.githubusercontent.com/Minecraft2613/taxess/main/bank-data.json";
const syncTaxURL = "https://syncs.1987sakshamsingh.workers.dev/";
const paymentHookURL = "https://discordapp.com/api/webhooks/1387003883947032596/BkLzoSlQk6wLaPP4voI2mAshDTfXRaGkFf0mbK1Y0xfvU2XytWazF3MFjpvgugHnkKuR";

let paidPlayers = {}, paymentHistory = {}, taxDeadline = {}, bankAccounts = {};

async function adminLogin() {
  const id = document.getElementById("adminId").value.trim();
  const pass = document.getElementById("adminPass").value.trim();

  try {
    const res = await fetch("https://raw.githubusercontent.com/Minecraft2613/taxess/main/admin.json");
    const admin = await res.json();

    // Get current user's public IP
    const ipRes = await fetch("https://api64.ipify.org?format=json");
    const { ip } = await ipRes.json();

    if (!admin.allowedIps.includes(ip)) {
      return alert(`‚ùå Access denied.\nYour IP (${ip}) is not authorized.`);
    }

    if (id === admin.id && pass === admin.pass) {
      alert("‚úÖ Admin Logged In");
      loadAllData();
    } else {
      alert("‚ùå Incorrect Admin Credentials");
    }
  } catch (e) {
    alert("‚ö†Ô∏è Failed to load admin data");
    console.error(e);
  }
}

async function loadAllData() {
  const [taxRes, bankRes] = await Promise.all([
    fetch(taxURL), fetch(bankURL)
  ]);
  const tax = await taxRes.json();
  const bank = await bankRes.json();
  paidPlayers = tax.paidPlayers || {};
  paymentHistory = tax.paymentHistory || {};
  taxDeadline = tax.taxDeadline || {};
  bankAccounts = bank.accounts || {};

  document.getElementById("adminPanel").style.display = "block";
  displayPlayers();
}

function displayPlayers() {
  const container = document.getElementById("playerList");
  container.innerHTML = "";

  Object.keys(bankAccounts).forEach(player => {
    const paid = (paymentHistory[player] || []).reduce((s, e) => s + e.amount, 0);
    const total = calculateTotalTax(player);
    const due = Math.max(0, total - paid);

    const div = document.createElement("div");
    div.className = "player";
    div.innerHTML = `
      <b>üë§ ${player}</b><br>
      üí∞ Total Tax: $${total.toFixed(2)}<br>
      ‚úÖ Paid: $${paid.toFixed(2)}<br>
      ‚ùó Due: $${due.toFixed(2)}<br>
      <input id="amt-${player}" type="number" placeholder="Amount" />
      <textarea id="desc-${player}" placeholder="Reason for payment (required)"></textarea>
      <button onclick="payAsGovt('${player}', ${due})">Pay on behalf</button>
    `;
    container.appendChild(div);
  });
}

function calculateTotalTax(player) {
  // Reparse transaction log for exact result (or hardcode example if log not available)
  return (window.dummyData && window.dummyData[player]) || 5000; // fallback value
}

function payAsGovt(player, maxDue) {
  const amt = parseFloat(document.getElementById(`amt-${player}`).value);
  const desc = document.getElementById(`desc-${player}`).value.trim();

  if (!amt || amt <= 0 || amt > maxDue) return alert("‚ùå Invalid amount");
  if (!desc) return alert("‚ùå Description is required");

  const entry = {
    amount: amt,
    date: new Date().toLocaleString(),
    adminNote: `Paid by government. Reason: ${desc}`
  };

  if (!paymentHistory[player]) paymentHistory[player] = [];
  paymentHistory[player].unshift(entry);
  paidPlayers[player] = paymentHistory[player].reduce((s, e) => s + e.amount, 0);

  // Send webhook
  fetch(paymentHookURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      content: `üèõÔ∏è **Govt Tax Payment**\nPlayer: \`${player}\`\nAmount: $${amt}\nReason: ${desc}`
    })
  });

  // Sync updated data
  fetch(syncTaxURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ paidPlayers, paymentHistory, taxDeadline })
  }).then(() => {
    alert("‚úÖ Tax paid and synced");
    displayPlayers();
  }).catch(err => {
    console.warn("Sync failed", err);
    alert("‚ö†Ô∏è Failed to sync");
  });
}
  {
  "id": "BANK631095",
  "pass": "36372613",
  "allowedDiscords": ["Ansh_2613", "Saksham#1234"]
}
const discord = prompt("Enter your Discord username (e.g. Ansh_2613)");

if (!admin.allowedDiscords.includes(discord)) {
  return alert("‚ùå This Discord is not authorized for admin access.");
}
if (!admin.allowedDiscords.includes(discord) || !admin.allowedIps.includes(ip)) {
  return alert(`‚ùå Unauthorized access.\nYour IP or Discord is not allowed.`);
}

</script>
</body>
</html>
